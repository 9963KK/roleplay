(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();const je=[{id:1,name:"智慧导师",icon:"🧙",description:"博学多才，善于解答各种问题",personality:"耐心、睿智、温和",background:"来自古老图书馆的智慧守护者，擅长将复杂知识拆解为可执行方案。",responseFormat:"回答包含背景、分析和行动建议三个段落。",avatarType:"pixel",avatarUrl:"",openingMessage:"你好！我是智慧导师，很高兴与你讨论任何问题。请告诉我你想探索的方向。",createdAt:"2024-01-15",lastActive:"刚刚",conversationCount:45},{id:2,name:"创意助手",icon:"🎨",description:"富有想象力，擅长创意和设计",personality:"活泼、创新、艺术感强",background:"常驻创意实验室，熟悉视觉艺术、品牌设计与叙事构建。",responseFormat:"先给一个灵感主题，再给三个可执行创意点子。",avatarType:"pixel",avatarUrl:"",openingMessage:"嗨！我是创意助手，随时准备一起头脑风暴。说说你脑海中的想法吧！",createdAt:"2024-01-10",lastActive:"5分钟前",conversationCount:38},{id:3,name:"商业顾问",icon:"💼",description:"专业商务，擅长策略分析和市场规划",personality:"理性、专业、目标导向",background:"来自国际咨询公司，熟悉市场分析、运营优化与财务模型。",responseFormat:"使用数字编号列出洞察、风险和行动建议。",avatarType:"pixel",avatarUrl:"",openingMessage:"您好，我是商业顾问。欢迎分享您的业务挑战，我们可以先明确目标再逐步分析。",createdAt:"2024-01-05",lastActive:"1小时前",conversationCount:44}],xe="app_characters";function Ke(e){return e.map(t=>({...t}))}function _e(e,t){const n=(e==null?void 0:e.avatarType)||(e!=null&&e.avatarUrl?"url":e!=null&&e.icon?"emoji":"pixel"),a=(e==null?void 0:e.avatarUrl)||"",o=typeof(e==null?void 0:e.icon)=="string"?e.icon:"";return{id:(e==null?void 0:e.id)??Date.now()+t,name:(e==null?void 0:e.name)||`角色${t+1}`,icon:o||"🧑",description:(e==null?void 0:e.description)||"",personality:(e==null?void 0:e.personality)||"",background:(e==null?void 0:e.background)||"",responseFormat:(e==null?void 0:e.responseFormat)||"",openingMessage:(e==null?void 0:e.openingMessage)||"",avatarType:n,avatarUrl:a,createdAt:(e==null?void 0:e.createdAt)||new Date().toISOString().split("T")[0],lastActive:(e==null?void 0:e.lastActive)||"刚刚",conversationCount:(e==null?void 0:e.conversationCount)||0}}function oe(e){try{localStorage.setItem(xe,JSON.stringify(e))}catch{}}function Ge(){try{const e=localStorage.getItem(xe);if(!e)return null;const t=JSON.parse(e);return!Array.isArray(t)||!t.length?null:t.map((n,a)=>_e(n,a))}catch{return null}}function Je(){const e=Ge();if(e)return e;const t=Ke(je).map((n,a)=>_e(n,a));return oe(t),t}let y=Je(),p=y[0]||null,S={},k={},A=null,U=null;const We="admin_character_prompts";let g={mode:"emoji",emoji:"",url:"",uploadData:"",uploadName:"",baseCharacter:null};const O=!!(window.SpeechRecognition||window.webkitSpeechRecognition),pe="cfg_voice_mode";function ue(){try{const e=localStorage.getItem(pe);if(e==="local"||e==="asr")return e==="local"&&!O?"asr":e}catch{}return O?"local":"asr"}const s={isRecording:!1,processing:!1,recognition:null,mediaRecorder:null,mediaStream:null,chunks:[],baseText:"",lastPartial:"",mode:ue(),activeMode:ue(),timerInterval:null,startTimestamp:0,discardRecording:!1,localUnavailableAlerted:!1};z(s.mode,{persist:!0,silent:!0});function Ye(e=""){var i;const t=[],n=/<think>([\s\S]*?)<\/think>/gi;let a=e,o=n.exec(e);for(;o;){const l=(i=o[1])==null?void 0:i.trim();l&&t.push(l),o=n.exec(e)}return a=e.replace(n,"").trim(),{cleanedText:a,thinkSegments:t}}function M(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function me(e=""){return M(e).replace(/\"/g,"&quot;").replace(/'/g,"&#39;")}function N(e,t=40){const n=Number.isFinite(t)?Math.max(24,t):40,a=`style="width:${n}px;height:${n}px;"`;if(!e)return`<div class="avatar-chip" ${a}><span class="avatar-emoji" style="font-size:${Math.round(n*.6)}px;">🖼️</span></div>`;const o=e.avatarType,i=e.avatarUrl;if((o==="url"||o==="upload")&&i)return`<div class="avatar-chip" ${a}><img src="${me(i)}" alt="${me(e.name||"avatar")}" /></div>`;if((o==="emoji"||!o&&e.icon)&&e.icon)return`<div class="avatar-chip" ${a}><span class="avatar-emoji" style="font-size:${Math.round(n*.6)}px;">${M(e.icon)}</span></div>`;const l=vt(e.name||"");return`<div class="avatar-chip avatar-pixel-wrapper" ${a}>${l}</div>`}let he=!1;function $e(e){he=e;const t=document.getElementById("messageInput"),n=document.querySelector(".send-btn");if(t)if(t.disabled=e,e)t.setAttribute("data-prev-ph",t.getAttribute("placeholder")||""),t.setAttribute("placeholder","正在生成回复…");else{const a=t.getAttribute("data-prev-ph");a!==null&&t.setAttribute("placeholder",a)}n&&(n.disabled=e)}function Z(e,t=Date.now()){const n=(e==null?void 0:e.openingMessage)&&e.openingMessage.trim()||`你好！我是${(e==null?void 0:e.name)||"伙伴"}，很高兴与你交流。`;return{type:"ai",author:(e==null?void 0:e.name)||"AI",text:n,time:ve(t),timestamp:t}}function Ze(){y.length&&y.forEach((e,t)=>{const a=ht(e.lastActive)??Date.now()-t*5*60*1e3;S[e.id]=[Z(e,a)],k[e.id]=[]})}function Xe(e){if(!e)return"";try{const t=localStorage.getItem(We);if(!t)return"";const n=JSON.parse(t);if(n&&typeof n=="object"){const a=n[e]??n[Number(e)]??null;return a?typeof a=="string"?a:(a==null?void 0:a.prompt)||"":""}return""}catch{return""}}function Qe(e){if(!e)return"";const t=[],n=Xe(e.id);return n&&t.push(n),e.description&&t.push(`角色定位：
${e.description}`),e.personality&&t.push(`性格特征：
${e.personality}`),e.background&&t.push(`背景信息：
${e.background}`),e.responseFormat&&t.push(`回答格式要求：
${e.responseFormat}`),t.join(`

`).trim()}function et(e,t){const n=[],a=Qe(t);return a&&n.push({role:"system",content:a}),n.push({role:"user",content:e}),n}function tt(){const e=document.querySelector(".avatar-upload-hint");if(!e)return;e.dataset.defaultHint||(e.dataset.defaultHint=e.textContent);const t=g.uploadData&&g.uploadName?`已选择：${g.uploadName}`:e.dataset.defaultHint;e.textContent=t;const n=document.querySelector(".avatar-upload-btn span");n&&(n.textContent=g.uploadData?"重新选择图片":"选择图片")}function nt(){if(g.mode==="emoji"&&g.emoji.trim())return{type:"emoji",value:g.emoji.trim()};if(g.mode==="url"&&g.url.trim())return{type:"image",value:g.url.trim()};if(g.mode==="upload"&&g.uploadData)return{type:"image",value:g.uploadData};const e=g.baseCharacter;if(e){if((e.avatarType==="url"||e.avatarType==="upload")&&e.avatarUrl)return{type:"image",value:e.avatarUrl};if(e.avatarType==="emoji"&&e.icon)return{type:"emoji",value:e.icon}}return{type:"placeholder",value:"🖼️"}}function q(){const e=document.getElementById("avatarPreview");if(!e)return;const t=nt();t.type==="image"?e.innerHTML=`<div class="avatar-img-wrapper"><img src="${me(t.value)}" alt="头像预览" /></div>`:t.type==="emoji"?e.innerHTML=`<span class="avatar-emoji">${M(t.value)}</span>`:e.innerHTML=`<span class="placeholder">${M(t.value)}</span>`,tt()}function ye(e,t=!0){g.mode=e,document.querySelectorAll(".avatar-mode-btn").forEach(n=>{n.classList.toggle("active",n.dataset.avatarMode===e)}),document.querySelectorAll(".avatar-input-field").forEach(n=>{const o=n.getAttribute("data-avatar-field")===e;if(n.classList.toggle("hidden",!o),o&&t){const i=n.querySelector('input:not([type="file"])');i==null||i.focus()}}),q()}function at(e){var a,o;const t=(o=(a=e.target)==null?void 0:a.files)==null?void 0:o[0];if(!t){g.uploadData="",g.uploadName="",q();return}const n=new FileReader;n.onload=i=>{var l;g.uploadData=((l=i.target)==null?void 0:l.result)||"",g.uploadName=t.name||"",ye("upload",!1),q()},n.readAsDataURL(t)}function Re(e){g={mode:"emoji",emoji:"",url:"",uploadData:"",uploadName:"",baseCharacter:e||null},e&&(e.avatarType==="url"?(g.mode="url",g.url=e.avatarUrl||""):e.avatarType==="upload"?(g.mode="upload",g.uploadData=e.avatarUrl||"",g.uploadName=e.avatarUrl?"已保存图片":""):e.avatarType==="emoji"?(g.mode="emoji",g.emoji=e.icon||""):e.icon&&(g.mode="emoji",g.emoji=e.icon));const t=document.getElementById("characterEmoji");t&&(t.value=g.emoji||"");const n=document.getElementById("characterAvatarUrl");n&&(n.value=g.url||"");const a=document.getElementById("characterAvatarFile");a&&(a.value=""),ye(g.mode,!1),q()}function ot(){var a,o;const e=(a=g.emoji)==null?void 0:a.trim(),t=(o=g.url)==null?void 0:o.trim();if(g.mode==="emoji"&&e)return{avatarType:"emoji",avatarUrl:"",icon:e};if(g.mode==="url"&&t)return{avatarType:"url",avatarUrl:t,icon:""};if(g.mode==="upload"&&g.uploadData)return{avatarType:"upload",avatarUrl:g.uploadData,icon:""};const n=g.baseCharacter;return n?{avatarType:n.avatarType||"emoji",avatarUrl:n.avatarUrl||"",icon:n.icon||""}:{avatarType:"emoji",avatarUrl:"",icon:e||"🙂"}}function ce(e){return e!=null&&e.length?`
    <details class="think-block">
      <summary>
        <span class="think-icon">🧠</span>
        <span class="think-label">查看思考内容</span>
        <span class="think-chevron">▾</span>
      </summary>
      <div class="think-body">${e.map(n=>`<div class="think-item">${be(n)}</div>`).join("")}</div>
    </details>
  `:""}function st(){var t;const e=localStorage.getItem("cfg_asr_model");if(e)return e;try{const n=localStorage.getItem("visible_asr_models");if(n){const a=JSON.parse(n);if(Array.isArray(a)&&a.length)return a[0]}}catch(n){console.warn("解析可见 ASR 模型失败",n)}return(t=r==null?void 0:r.defaults)!=null&&t.asr&&r.defaults.asr.length?r.defaults.asr[0]:""}function ke(){return s.mode}function z(e,t={}){if(e!=="local"&&e!=="asr")return;let n=e;e==="local"&&!O&&(!t.silent&&!s.localUnavailableAlerted&&(alert("当前浏览器不支持本地语音识别，将继续使用云端 ASR"),s.localUnavailableAlerted=!0),n="asr");const a=s.mode!==n;if(s.mode=n,a&&t.persist!==!1)try{localStorage.setItem(pe,n)}catch{}s.isRecording||(s.activeMode=n),C()}function it(){const e=s.mode==="local"?"asr":"local";z(e,{silent:e!=="local"})}function C(){var n;const e=document.getElementById("voiceModeToggle");e&&(e.textContent=s.mode==="asr"?"云端":"本地",e.setAttribute("data-mode",s.mode),e.title=s.mode==="asr"?"当前：云端 ASR 识别（点击切换）":"当前：本地语音识别（点击切换）",e.disabled=!O);const t=document.querySelector('[data-action="voice"]');if(t){const a=s.isRecording?s.activeMode:s.mode;t.setAttribute("data-voice-mode",a),t.title=a==="asr"?"语音输入（云端 ASR）":"语音输入（本地识别）"}(n=document.querySelectorAll("[data-voice-mode-option]"))==null||n.forEach(a=>{const o=a.getAttribute("data-voice-mode-option");a.classList.toggle("active",o===s.mode),o==="local"&&(a.disabled=!O)})}function R(){const e=document.querySelector('[data-action="voice"]');e&&(e.classList.toggle("recording",s.isRecording),e.classList.toggle("loading",s.processing),e.setAttribute("aria-pressed",s.isRecording?"true":"false"),e.disabled=s.processing)}function Be(e){s.processing=e,R()}function ge(e=0){const t=document.getElementById("recordingTimer");if(!t)return;const n=Math.max(0,Math.floor(e/1e3)),a=Math.floor(n/60),o=n%60;t.textContent=`${a}:${o.toString().padStart(2,"0")}`}function rt(){const e=document.getElementById("messageInput"),t=document.getElementById("recordingVisual");t&&(e&&e.classList.add("hidden"),t.classList.remove("hidden"),t.setAttribute("aria-hidden","false"),s.startTimestamp=Date.now(),ge(0),s.timerInterval&&clearInterval(s.timerInterval),s.timerInterval=setInterval(()=>{ge(Date.now()-s.startTimestamp)},200))}function X(){const e=document.getElementById("messageInput"),t=document.getElementById("recordingVisual");s.timerInterval&&(clearInterval(s.timerInterval),s.timerInterval=null),s.startTimestamp=0,t&&!t.classList.contains("hidden")&&(t.classList.add("hidden"),t.setAttribute("aria-hidden","true")),e&&e.classList.remove("hidden"),ge(0)}function Q(e,t=!1){const n=document.getElementById("messageInput");if(!n)return;const a=(e||"").trim();if(t)s.baseText=[s.baseText,a].filter(Boolean).join(" ").trim(),s.lastPartial="",n.value=s.baseText;else{s.lastPartial=a;const o=[s.baseText,s.lastPartial].filter(Boolean).join(" ").trim();n.value=o}n.focus()}function fe(){var e;s.mediaStream&&((e=s.mediaStream.getTracks())==null||e.forEach(t=>t.stop())),s.mediaStream=null}function se(e=!0){if(s.isRecording){if(s.recognition){const t=s.recognition;s.recognition=null,t.stop(),s.isRecording=!1,s.activeMode=s.mode,e&&s.lastPartial&&Q(s.lastPartial,!0),R();return}if(s.mediaRecorder)try{s.discardRecording=!e,s.mediaRecorder.stop()}catch(t){console.warn("停止录音失败",t)}fe(),s.isRecording=!1,s.activeMode=s.mode,X(),R()}}async function lt(e){var t,n,a,o,i,l;if(!(!e||!e.size)){Be(!0);try{await Ie();const c=localStorage.getItem("dev_enabled")==="true",m=st(),d=new FormData;d.append("file",e,`recording-${Date.now()}.webm`),m&&d.append("model",m);let u="";const v={};if(c){const w=localStorage.getItem("dev_asr_base")||((t=r==null?void 0:r.dev)==null?void 0:t.asrBase)||((n=r==null?void 0:r.dev)==null?void 0:n.llmBase);if(!w)throw new Error("未配置 ASR Base 地址");const L=((a=r==null?void 0:r.dev)==null?void 0:a.asrTranscribeEndpoint)||"/v1/audio/transcriptions";u=`${w}${L}`;const x=localStorage.getItem("dev_asr_key");if(x){const _=((o=r==null?void 0:r.dev)==null?void 0:o.authHeader)||"Authorization",b=((i=r==null?void 0:r.dev)==null?void 0:i.authScheme)||"Bearer";v[_]=`${b} ${x}`}}else{const w=(r==null?void 0:r.apiBase)||"",L=(r==null?void 0:r.asrRoute)||"/asr/transcribe";u=`${w}${L}`}const f=await fetch(u,{method:"POST",headers:v,body:d});if(!f.ok){const w=await f.text().catch(()=>"");throw new Error(w||`HTTP ${f.status}`)}const h=await f.json().catch(()=>({})),T=h.text||h.transcript||h.result||((l=h.data)==null?void 0:l.text)||"";T?Q(T,!0):alert("未获取到识别结果")}catch(c){console.error("ASR 请求失败",c),alert(`语音识别失败：${(c==null?void 0:c.message)||c}`)}finally{Be(!1)}}}function ct(){var t;const e=window.SpeechRecognition||window.webkitSpeechRecognition;if(!e)return!1;try{const n=new e;return n.lang=navigator.language||"zh-CN",n.interimResults=!0,n.continuous=!0,s.baseText=(((t=document.getElementById("messageInput"))==null?void 0:t.value)||"").trim(),s.lastPartial="",n.onresult=a=>{var l;let o="",i="";for(let c=a.resultIndex;c<a.results.length;c+=1){const m=a.results[c];if(!m)continue;const d=((l=m[0])==null?void 0:l.transcript)||"";m.isFinal?i+=d:o+=d}o&&Q(o,!1),i&&Q(i,!0)},n.onerror=a=>{console.error("SpeechRecognition error",a),alert(`语音识别错误：${(a==null?void 0:a.error)||"未知错误"}`),se(!1),s.activeMode=s.mode,C()},n.onend=()=>{s.recognition=null,s.isRecording=!1,s.activeMode=s.mode,R(),C()},n.start(),s.recognition=n,s.activeMode="local",s.isRecording=!0,X(),C(),R(),!0}catch(n){return console.warn("SpeechRecognition 启动失败",n),!1}}async function de(){var e,t;try{if(!((e=navigator.mediaDevices)!=null&&e.getUserMedia))throw new Error("当前浏览器不支持麦克风采集");const n=await navigator.mediaDevices.getUserMedia({audio:!0}),a=MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?"audio/webm;codecs=opus":"audio/webm",o=new MediaRecorder(n,{mimeType:a});s.mediaRecorder=o,s.mediaStream=n,s.chunks=[],s.baseText=(((t=document.getElementById("messageInput"))==null?void 0:t.value)||"").trim(),s.lastPartial="",s.activeMode="asr",s.discardRecording=!1,rt(),o.addEventListener("dataavailable",i=>{i.data&&i.data.size>0&&s.chunks.push(i.data)}),o.addEventListener("stop",async()=>{const i=new Blob(s.chunks,{type:o.mimeType}),l=s.discardRecording;s.discardRecording=!1,fe(),s.mediaRecorder=null,s.isRecording=!1,s.activeMode=s.mode,X(),R(),s.chunks=[],i.size>0&&!l&&await lt(i)}),o.start(),s.isRecording=!0,C(),R()}catch(n){console.error("启动 MediaRecorder 失败",n),alert(`无法访问麦克风：${(n==null?void 0:n.message)||n}`),fe(),s.mediaRecorder=null,s.isRecording=!1,X(),R()}}function dt(e){if(!e)return null;const t=e.split(/\n+/).map(i=>i.trim()).filter(Boolean);if(t.length<4)return null;const n=/^([A-Za-z\u4e00-\u9fa5]{1,16})(?:[:：])?$/,a=[];let o=null;return t.forEach(i=>{n.test(i)&&i.length<=10?(o&&a.push(o),o={title:i.replace(/[:：]$/,""),body:[]}):(o||(o={title:"思考",body:[]}),o.body.push(i))}),o&&a.push(o),a.length<2?null:a}function ut(e){const t=dt(e);if(!t)return null;const n={背景:"🗺️",角色:"🧍",思考:"🧠",分析:"🔍",计划:"🗒️",策略:"🧭",行动建议:"✅",建议:"✅",结果:"📌",总结:"📘"},a=["🧠","🔍","✅","💡","🗺️"];let o=0;return`<div class="reasoning-bubble">${t.map(l=>{const c=n[l.title]||a[o++%a.length],m=l.body.join(`
`),d=be(m);return`
        <div class="reasoning-section">
          <div class="reasoning-title"><span class="reasoning-icon">${c}</span><span>${M(l.title)}</span></div>
          <div class="reasoning-body">${d}</div>
        </div>
      `}).join("")}</div>`}function mt(){return`
  <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
    <rect x="6" y="1" width="4" height="2" fill="#5d4037"/>
    <rect x="5" y="3" width="6" height="2" fill="#5d4037"/>
    <rect x="4" y="5" width="8" height="1" fill="#5d4037"/>
    <rect x="3" y="6" width="10" height="1" fill="#5d4037"/>
    <rect x="6" y="7" width="4" height="3" fill="#f3c26b"/>
    <rect x="5" y="10" width="6" height="4" fill="#6a1b9a"/>
    <rect x="11" y="9" width="1" height="5" fill="#2e7d32"/>
    <rect x="12" y="9" width="1" height="1" fill="#a5d6a7"/>
  </svg>`}function gt(){return`
  <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
    <rect x="6" y="6" width="4" height="3" fill="#f3c26b"/>
    <rect x="5" y="9" width="6" height="5" fill="#8e44ad"/>
    <rect x="9" y="4" width="3" height="2" fill="#7f8c8d"/>
    <rect x="3" y="10" width="3" height="2" fill="#c49b6e"/>
    <rect x="3" y="10" width="1" height="1" fill="#e74c3c"/>
    <rect x="4" y="11" width="1" height="1" fill="#3498db"/>
    <rect x="5" y="10" width="1" height="1" fill="#f1c40f"/>
  </svg>`}function ft(){return`
  <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
    <rect x="6" y="6" width="4" height="3" fill="#f3c26b"/>
    <rect x="5" y="9" width="6" height="5" fill="#34495e"/>
    <rect x="7" y="11" width="2" height="2" fill="#ecf0f1"/>
    <rect x="6" y="4" width="4" height="2" fill="#7f8c8d"/>
  </svg>`}function Ce(){return`
  <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
    <rect x="6" y="6" width="4" height="3" fill="#f3c26b"/>
    <rect x="5" y="9" width="6" height="5" fill="#6d4c41"/>
  </svg>`}function vt(e){return e==="智慧导师"?mt():e==="创意助手"?gt():e==="商业顾问"?ft():Ce()}function ve(e){return new Date(e).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})}function pt(e){const t=Date.now()-e,n=60*1e3,a=60*n,o=24*a;return t<n?"刚刚":t<a?`${Math.floor(t/n)}分钟前`:t<o?`${Math.floor(t/a)}小时前`:new Date(e).toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})}function ht(e){if(!e)return;if(e.includes("刚刚"))return Date.now();const t=e.match(/(\d+)分钟/);if(t)return Date.now()-parseInt(t[1],10)*60*1e3;const n=e.match(/(\d+)小时/);if(n)return Date.now()-parseInt(n[1],10)*60*60*1e3}function F(){var a;const e=document.getElementById("historyList");if(!e)return;e.innerHTML="";const t=(((a=document.getElementById("historySearch"))==null?void 0:a.value)||"").trim().toLowerCase(),n=[];y.forEach(o=>{const i=S[o.id]||[];if(i.length){const l=i[i.length-1];n.push({type:"current",char:o,sessionId:"current",lastMsg:l,lastTs:l.timestamp})}(k[o.id]||[]).forEach(l=>{const c=l.messages[l.messages.length-1];n.push({type:"archived",char:o,sessionId:l.id,lastMsg:c,lastTs:(c==null?void 0:c.timestamp)||0})})}),n.sort((o,i)=>i.lastTs-o.lastTs),n.forEach(o=>{const{char:i,type:l,sessionId:c,lastMsg:m,lastTs:d}=o,u=d?pt(d):"",v=m?m.text:l==="archived"?"历史会话":"暂无对话";if(t&&!(i.name.toLowerCase().includes(t)||v.toLowerCase().includes(t)))return;const f=document.createElement("div");f.className="history-item",f.onclick=()=>{l==="archived"?yt(i.id,c):(A=null,we(i.id))},f.innerHTML=`
      <div class="history-main">
        <div class="history-title">
          <span class="history-name">${v}</span>
          <span class="history-time">${u}</span>
        </div>
      </div>
      <button class="history-del-btn" title="删除" aria-label="删除">
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
          <path d="M10 11v6"></path>
          <path d="M14 11v6"></path>
          <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>
        </svg>
      </button>
    `;const h=f.querySelector(".history-del-btn");h.onclick=T=>{T.stopPropagation(),wt(i.id,l,c)},e.appendChild(f)})}function yt(e,t){const n=document.getElementById("chatMessages");if(!n)return;n.innerHTML="";const a=(k[e]||[]).find(o=>o.id===t);a&&(A={charId:e,sessionId:t},a.messages.forEach(o=>ne(o)))}function wt(e,t,n){if(window.confirm("确定删除该对话吗？删除后无法恢复")){if(t==="archived"){if(k[e]=(k[e]||[]).filter(o=>o.id!==n),A&&A.charId===e&&A.sessionId===n){A=null;const o=document.getElementById("chatMessages");o&&(o.innerHTML="")}}else if(S[e]=[],!A&&p&&p.id===e){const o=document.getElementById("chatMessages");o&&(o.innerHTML="")}F()}}function ie(){const e=document.getElementById("roleDropdown");if(!e)return;e.innerHTML="";const t=p==null?void 0:p.id;y.forEach(n=>{const a=document.createElement("div");a.className=`model-item ${t&&n.id===t?"active":""}`;const o=N(n,36);a.innerHTML=`
      <div class="avatar">${o}</div>
      <div class="name">${M(n.name)}</div>
    `,a.onclick=()=>{we(n.id),De();const i=document.getElementById("roleSwitcherLabel");i&&(i.textContent=p.name);const l=document.getElementById("currentCharacterAvatar");l&&(l.classList.remove("pulse"),l.offsetWidth,l.classList.add("pulse"))},e.appendChild(a)})}function Ae(){const e=document.getElementById("roleDropdown");e&&(e.classList.contains("hidden")?(ie(),e.classList.remove("hidden"),e.classList.add("show")):(e.classList.remove("show"),e.classList.add("hidden")))}function De(){const e=document.getElementById("roleDropdown");e==null||e.classList.add("hidden")}function ee(){const e=document.getElementById("characterList");e&&(e.innerHTML="",y.forEach(t=>{const n=document.createElement("div"),a=p&&t.id===p.id;n.className=`character-item ${a?"active":""}`,n.onclick=()=>we(t.id);const o=N(t);n.innerHTML=`
      <div class="character-header">
        <div class="character-avatar">${o}</div>
        <div class="character-name">${M(t.name)}</div>
      </div>
      <div class="character-desc">${M(t.description)}</div>
      <div style="font-size: 10px; color: #8b4513; margin-top: 5px;">
        最后对话：${M(t.lastActive)}
      </div>
    `,e.appendChild(n)}))}function te(){const e=document.getElementById("characterManagement");e&&(e.innerHTML="",y.forEach(t=>{const n=document.createElement("div");n.className="character-card";const a=N(t,60);n.innerHTML=`
      <div class="character-avatar" style="width: 60px; height: 60px;">${a}</div>
      <div class="character-card-info">
        <h3>${M(t.name)}</h3>
        <p>描述：${M(t.description)}</p>
        <p>性格：${M(t.personality)}</p>
        ${t.background?`<p>背景：${M(t.background)}</p>`:""}
        ${t.responseFormat?`<p>回答格式：${M(t.responseFormat)}</p>`:""}
        <div class="meta">创建时间：${M(t.createdAt)}</div>
      </div>
      <div class="character-actions">
        <button class="btn btn-small btn-edit" onclick="editCharacter(${t.id})">编辑</button>
        <button class="btn btn-small btn-delete" onclick="deleteCharacter(${t.id})">删除</button>
      </div>
    `,e.appendChild(n)}))}function j(){const e=document.getElementById("currentCharacterAvatar"),t=document.getElementById("currentCharacterName");if(!p){e&&(e.innerHTML=N(null,48)),t&&(t.textContent="");return}e&&(e.innerHTML=N(p,48)),t&&(t.textContent=p.name)}function we(e){const t=y.find(n=>n.id===e);t&&(p=t,ee(),ie(),K(e),j())}function K(e){const t=document.getElementById("chatMessages");if(!t)return;t.innerHTML="",(S[e]||[]).forEach(a=>{ne(a)}),t.scrollTop=t.scrollHeight}function ne(e){const t=document.getElementById("chatMessages");if(!t)return;const n=document.createElement("div");n.className=`message ${e.type}`;const a=e.type==="ai"?N(p,36):`<div class="avatar-chip" style="width:36px;height:36px;">${Ce()}</div>`,o=t.lastElementChild;if(o&&o.classList.contains(e.type)&&n.classList.add("grouped"),e.type==="ai"){const{cleanedText:l,thinkSegments:c}=Ye(e.text);n.innerHTML=`
      <div class="message-avatar">${a}</div>
      <div class="message-content"><div class="message-text"></div></div>
      <div class="message-time outside">${e.time}</div>
    `;try{const m=n.querySelector(".message-text");if(m){const d=ut(l);d?(n.classList.add("ai-reasoning"),m.innerHTML=d,c.length&&m.insertAdjacentHTML("beforeend",ce(c))):(m.innerHTML=be(l||""),c.length&&m.insertAdjacentHTML("beforeend",ce(c)))}}catch{const d=n.querySelector(".message-text");d&&(d.textContent=l||e.text,c.length&&d.insertAdjacentHTML("beforeend",ce(c)))}}else{n.innerHTML=`
      <div class="message-time outside">${e.time}</div>
      <div class="message-content"><div class="message-text"></div></div>
      <div class="message-avatar">${a}</div>
    `;const l=n.querySelector(".message-text");l.textContent=e.text}t.appendChild(n)}function He(){if(!p||he)return;const e=document.getElementById("messageInput");if(!e)return;const t=e.value.trim();if(!t)return;const n=Date.now(),a={type:"user",text:t,time:ve(n),timestamp:n};A=null,S[p.id]=S[p.id]||[],S[p.id].push(a),ne(a),e.value="",Le(),$e(!0);const o=document.getElementById("chatMessages"),i=document.createElement("div");i.className="message ai typing",i.innerHTML=`
    <div class="message-avatar">${N(p,36)}</div>
    <div class="message-content"><div class="typing-dots"><span></span><span></span><span></span></div></div>
  `,o.appendChild(i),setTimeout(()=>{const l=m=>{const d=Date.now(),u={type:"ai",author:p.name,text:m,time:ve(d),timestamp:d};i.remove(),S[p.id].push(u),ne(u);const v=document.getElementById("chatMessages");v&&(v.scrollTop=v.scrollHeight),Le(),$e(!1)},c=et(t,p);localStorage.getItem("dev_enabled")==="true"?Ie().then(()=>{r.dev=r.dev||{},r.dev.enabled=!0,r.dev.llmBase=localStorage.getItem("dev_llm_base")||r.dev.llmBase,localStorage.getItem("dev_api_key");let m="";It(c,d=>{m+=d;const u=i.querySelector(".message-content");u&&(u.innerHTML=m);const v=document.getElementById("chatMessages");v&&(v.scrollTop=v.scrollHeight)},()=>{l(m||"")},d=>{const u=typeof d=="string"?d:(d==null?void 0:d.message)||"未知错误";l(`调用失败：${u}`)})}):l(bt(t,p))},1e3)}function bt(e,t){const a={智慧导师:["这是一个很有趣的问题，让我来为你详细解答。","从我的经验来看，这个问题有几个关键点需要考虑。","你提出了一个很好的观点，我建议你可以从以下几个方面深入思考。"],创意助手:["哇！这个想法太有创意了！我有一些更有趣的建议给你。","让我发挥一下想象力，我觉得可以这样设计...","这个概念很棒！我们可以加入更多创新的元素。"],商业顾问:["从商业角度分析，这个方案有几个优势和需要注意的风险。","根据市场调研数据，我建议采用以下策略来优化这个项目。","这个投资机会看起来很有潜力，但我们需要仔细评估ROI。"]}[t.name]||["这是一个很好的问题，让我为你分析一下。"];return a[Math.floor(Math.random()*a.length)]}function be(e){if(!e)return"";let t=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");const n=[];return t=t.replace(/```([a-zA-Z0-9_-]+)?\n([\s\S]*?)```/g,(a,o,i)=>{const l=`__CODE_${n.length}__`;return n.push(`<pre><code class="lang-${o||"plain"}">${i}</code></pre>`),l}),t=t.replace(/^######\s+(.+)$/gm,"<h6>$1</h6>").replace(/^#####\s+(.+)$/gm,"<h5>$1</h5>").replace(/^####\s+(.+)$/gm,"<h4>$1</h4>").replace(/^###\s+(.+)$/gm,"<h3>$1</h3>").replace(/^##\s+(.+)$/gm,"<h2>$1</h2>").replace(/^#\s+(.+)$/gm,"<h1>$1</h1>"),t=t.replace(/^>\s+(.+)$/gm,"<blockquote>$1</blockquote>"),t=t.replace(/^(?:\-|\*)\s+(.+)$/gm,"<li>$1</li>"),t=t.replace(/(?:<li>.*<\/li>\n?)+/gs,a=>`<ul>${a}</ul>`),t=t.replace(/^(\d+)\.\s+(.+)$/gm,"<li>$2</li>"),t=t.replace(/(?:<li>.*<\/li>\n?)+/gs,a=>a.startsWith("<ul>")?a:`<ol>${a}</ol>`),t=t.replace(/\[([^\]]+)\]\((https?:[^)\s]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'),t=t.replace(/`([^`]+)`/g,"<code>$1</code>"),t=t.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),t=t.replace(new RegExp("(?<!\\*)\\*(?!\\*)(.+?)(?<!\\*)\\*(?!\\*)","g"),"<em>$1</em>"),t=t.replace(/^(-{3,}|\*{3,})$/gm,"<hr/>"),t=t.replace(/(^|\n)(?!<(h\d|ul|ol|li|pre|blockquote|hr|p|code))([^\n]+)(?=\n|$)/g,(a,o,i,l)=>`${o}<p>${l}</p>`),n.forEach((a,o)=>{t=t.replace(`__CODE_${o}__`,a)}),t}async function It(e,t,n,a){var v,f,h,T,w,L,x,_,b,E,$;const o=new AbortController,i=2e4,l=12e4;let c=null,m=null;const d=()=>{c&&clearTimeout(c),c=setTimeout(()=>{o.abort("idle-timeout")},i)},u=()=>{c&&clearTimeout(c),m&&clearTimeout(m),c=null,m=null};try{const B=localStorage.getItem("dev_llm_base")||((v=r==null?void 0:r.dev)==null?void 0:v.llmBase),D=localStorage.getItem("dev_api_key")||"",H=localStorage.getItem("cfg_llm_model")||((h=(f=r.defaults)==null?void 0:f.llm)==null?void 0:h[0])||"",P=Array.isArray(e)&&e.length?e:[{role:"user",content:typeof e=="string"?e:""}];if(!B||!D||!H)throw new Error("缺少 base/key/model");const G=((T=r==null?void 0:r.dev)==null?void 0:T.authHeader)||"Authorization",J=((w=r==null?void 0:r.dev)==null?void 0:w.authScheme)||"Bearer";m=setTimeout(()=>o.abort("hard-timeout"),l),d();const I=await fetch(`${B}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"text/event-stream",[G]:`${J} ${D}`},body:JSON.stringify({model:H,stream:!0,messages:P}),signal:o.signal});if(!I.ok){const le=await I.text();throw new Error(le||`HTTP ${I.status}`)}const W=I.body.getReader(),Pe=new TextDecoder;let re="";for(;;){const{value:le,done:Ue}=await W.read();if(Ue)break;d(),re+=Pe.decode(le,{stream:!0});const Ee=re.split(/\r?\n\r?\n/);re=Ee.pop();for(const Fe of Ee){const qe=Fe.split(/\r?\n/).filter(Boolean);for(const ze of qe){const Me=ze.replace(/\r$/,"").match(/^data:\s*(.*)$/);if(!Me)continue;const Se=(Me[1]||"").trim();if(Se==="[DONE]"){u(),n&&n();return}try{const V=JSON.parse(Se),Te=((_=(x=(L=V==null?void 0:V.choices)==null?void 0:L[0])==null?void 0:x.delta)==null?void 0:_.content)||(($=(E=(b=V==null?void 0:V.choices)==null?void 0:b[0])==null?void 0:E.message)==null?void 0:$.content)||"";Te&&t&&t(Te)}catch{}}}}u(),n&&n()}catch(B){u(),a&&a(B)}}function Et(e){e.key==="Enter"&&(e.preventDefault(),he||He())}function Mt(){const e=document.getElementById("chatInterface"),t=document.getElementById("settingsInterface");e==null||e.classList.remove("active"),t==null||t.classList.add("active")}function St(){const e=document.getElementById("chatInterface"),t=document.getElementById("settingsInterface");t==null||t.classList.remove("active"),e==null||e.classList.add("active")}function Ve(e,t){var a;document.querySelectorAll(".menu-item").forEach(o=>o.classList.remove("active")),e.currentTarget.classList.add("active");const n={characters:document.getElementById("panel-characters"),models:document.getElementById("panel-models")};Object.values(n).forEach(o=>o==null?void 0:o.classList.add("hidden")),(a=n[t])==null||a.classList.remove("hidden")}let r=null;function Ie(){return r?Promise.resolve(r):fetch("/app-config.json",{cache:"no-store"}).then(e=>e.json()).then(e=>r=e).catch(()=>r={defaults:{}})}function Y(e,t){var o,i,l,c;const a={VITE_LLM_MODELS:(o=r==null?void 0:r.defaults)==null?void 0:o.llm,VITE_ASR_MODELS:(i=r==null?void 0:r.defaults)==null?void 0:i.asr,VITE_TTS_VOICES:(l=r==null?void 0:r.defaults)==null?void 0:l.ttsVoices,VITE_VOICE_MODELS:(c=r==null?void 0:r.defaults)==null?void 0:c.voiceModels}[e];return Array.isArray(a)&&a.length?a:t}function Tt(){const e=Y("VITE_LLM_MODELS",["gpt-4o-mini","claude-3.5-haiku","qwen2.5-14b"]),t=Y("VITE_ASR_MODELS",["deepgram:nova-2","whisper:large-v3","azure:speech"]),n=Y("VITE_TTS_VOICES",["openai:alloy","elevenlabs:Rachel","azure:zh-CN-XiaoxiaoNeural"]),a=Y("VITE_VOICE_MODELS",["openai:gpt-4o-realtime","deepgram:aura"]),o=(d,u)=>{try{const v=localStorage.getItem(d);return v?JSON.parse(v):u}catch{return u}},i=o("visible_llm_models",e).filter(Boolean),l=o("visible_asr_models",t).filter(Boolean),c=o("visible_tts_voices",n).filter(Boolean),m=o("visible_voice_models",a).filter(Boolean);return{llm:i,asr:l,ttsVoices:c,voiceModels:m}}function Oe(){var a,o,i,l;const e=document.getElementById("panel-models");if(!e)return;const t=c=>{var L,x,_;const{llm:m,asr:d,ttsVoices:u,voiceModels:v}=c,f=(b,E)=>localStorage.getItem(b)||E,h={llm:f("cfg_llm_model",m[0]||""),asr:f("cfg_asr_model",d[0]||""),tts:f("cfg_tts_voice",u[0]||""),vrm:f("cfg_voice_model",v[0]||"")},T=ke(),w=(b,E)=>b.map($=>`<option value="${$}" ${$===E?"selected":""}>${$}</option>`).join("");e.innerHTML=`
      <div class="form-section">
        <div class="form-row">
          <label>文本 LLM</label>
          <select id="sel-llm" class="select">${w(m,h.llm)}</select>
        </div>
        <div class="form-row">
          <label>ASR（语音识别）</label>
          <select id="sel-asr" class="select">${w(d,h.asr)}</select>
        </div>
        <div class="form-row">
          <label>语音输入模式</label>
          <div>
            <div class="segmented" role="group" aria-label="语音输入模式">
              <button type="button" class="seg-btn ${T==="local"?"active":""}" data-voice-mode-option="local">本地实时</button>
              <button type="button" class="seg-btn ${T==="asr"?"active":""}" data-voice-mode-option="asr">云端 ASR</button>
            </div>
            <div class="field-note">${O?"本地模式依赖浏览器的语音识别能力，云端模式走选定的 ASR 模型。":"当前浏览器不支持本地语音识别，将默认使用云端 ASR。"}</div>
          </div>
        </div>
        <div class="form-row">
          <label>TTS 声音</label>
          <select id="sel-tts" class="select">${w(u,h.tts)}</select>
        </div>
        <div class="form-row">
          <label>语音大模型</label>
          <select id="sel-vrm" class="select">${w(v,h.vrm)}</select>
        </div>
        <div class="form-actions">
          <button id="btn-save-models" class="btn">保存</button>
          <button id="btn-reset-models" class="btn btn-secondary">恢复默认</button>
        </div>
      </div>
    `,(L=document.getElementById("btn-save-models"))==null||L.addEventListener("click",()=>{const b=document.getElementById("sel-llm"),E=document.getElementById("sel-asr"),$=document.getElementById("sel-tts"),B=document.getElementById("sel-vrm");localStorage.setItem("cfg_llm_model",(b==null?void 0:b.value)||""),localStorage.setItem("cfg_asr_model",(E==null?void 0:E.value)||""),localStorage.setItem("cfg_tts_voice",($==null?void 0:$.value)||""),localStorage.setItem("cfg_voice_model",(B==null?void 0:B.value)||""),alert("已保存模型与声音选择")}),(x=document.getElementById("btn-reset-models"))==null||x.addEventListener("click",()=>{localStorage.removeItem("cfg_llm_model"),localStorage.removeItem("cfg_asr_model"),localStorage.removeItem("cfg_tts_voice"),localStorage.removeItem("cfg_voice_model"),localStorage.removeItem(pe),z(ue(),{persist:!0,silent:!0}),Oe()}),(_=e.querySelectorAll("[data-voice-mode-option]"))==null||_.forEach(b=>{b.addEventListener("click",()=>{const E=b.getAttribute("data-voice-mode-option");E&&z(E)})}),C()};t(Tt());const n=(r==null?void 0:r.visibleModelsUrl)||"";if(n&&fetch(n).then(c=>c.json()).then(c=>{const m={llm:c.llm||c.llms||[],asr:c.asr||c.asrs||[],ttsVoices:c.ttsVoices||c.tts||[],voiceModels:c.voiceModels||c.vrm||[]};(m.llm.length||m.asr.length||m.ttsVoices.length||m.voiceModels.length)&&t(m)}).catch(()=>{}),localStorage.getItem("dev_enabled")==="true"){const c=localStorage.getItem("dev_llm_base")||((a=r==null?void 0:r.dev)==null?void 0:a.llmBase),m=localStorage.getItem("dev_api_key"),d=((o=r==null?void 0:r.dev)==null?void 0:o.modelsEndpoint)||"/models";c&&m&&fetch(`${c}${d}`,{headers:{[((i=r==null?void 0:r.dev)==null?void 0:i.authHeader)||"Authorization"]:`${((l=r==null?void 0:r.dev)==null?void 0:l.authScheme)||"Bearer"} ${m}`}}).then(u=>u.json()).then(u=>{var f,h,T;const v=Array.isArray(u==null?void 0:u.data)?u.data.map(w=>w.id).filter(Boolean):(u==null?void 0:u.models)||[];if(v.length){const w={llm:v,asr:[],ttsVoices:[],voiceModels:[]},L=localStorage.getItem("dev_asr_base")||c,x=localStorage.getItem("dev_asr_key")||m,_=localStorage.getItem("dev_tts_base")||c,b=localStorage.getItem("dev_tts_key")||m,E=localStorage.getItem("dev_vrm_base")||c,$=localStorage.getItem("dev_vrm_key")||m,B=(D,H,P)=>{var G,J;return!P||!D||!H?Promise.resolve([]):fetch(`${D}${P}`,{headers:{[((G=r==null?void 0:r.dev)==null?void 0:G.authHeader)||"Authorization"]:`${((J=r==null?void 0:r.dev)==null?void 0:J.authScheme)||"Bearer"} ${H}`}}).then(I=>I.json()).then(I=>Array.isArray(I==null?void 0:I.data)?I.data.map(W=>W.id||W.name).filter(Boolean):(I==null?void 0:I.items)||(I==null?void 0:I.models)||[]).catch(()=>[])};Promise.all([B(L,x,(f=r==null?void 0:r.dev)==null?void 0:f.asrModelsEndpoint),B(_,b,(h=r==null?void 0:r.dev)==null?void 0:h.ttsVoicesEndpoint),B(E,$,(T=r==null?void 0:r.dev)==null?void 0:T.voiceModelsEndpoint)]).then(([D,H,P])=>{w.asr=D,w.ttsVoices=H,w.voiceModels=P,t(w)})}}).catch(()=>{})}}function $t(){U=null;const e=document.getElementById("modalTitle");e.textContent="添加新人物",document.getElementById("characterForm").reset(),Re(null),document.getElementById("characterModal").style.display="block"}function Bt(e){const t=y.find(n=>n.id===e);t&&(U=e,document.getElementById("modalTitle").textContent="编辑人物",document.getElementById("characterName").value=t.name,document.getElementById("characterDesc").value=t.description,document.getElementById("characterPersonality").value=t.personality,document.getElementById("characterBackground").value=t.background||"",document.getElementById("characterFormat").value=t.responseFormat||"",document.getElementById("characterOpening").value=t.openingMessage||"",Re(t),document.getElementById("characterModal").style.display="block")}function At(e){if(confirm("确定要删除这个人物吗？"))if(y=y.filter(t=>t.id!==e),delete S[e],p&&p.id===e&&y.length>0?p=y[0]:y.length||(p=null),oe(y),ee(),te(),ae(),y.length>0&&p)K(p.id),j();else{j();const t=document.getElementById("chatMessages");t&&(t.innerHTML="")}}function Ne(){document.getElementById("characterModal").style.display="none"}function ae(){const e=y.length,t=Object.values(S).reduce((l,c)=>l+c.filter(m=>m.type==="user").length,0),n=y.reduce((l,c)=>l.conversationCount>c.conversationCount?l:c,y[0]),a=document.getElementById("totalCharacters"),o=document.getElementById("totalConversations"),i=document.getElementById("mostActive");a&&(a.textContent=e),o&&(o.textContent=t),i&&(i.textContent=n?n.name:"无")}function Le(){if(!p)return;const e=y.find(t=>t.id===p.id);e&&(e.lastActive="刚刚",e.conversationCount=(e.conversationCount||0)+1,oe(y)),F(),te(),ie(),ae()}function Lt(){alert("附件功能开发中...")}function xt(){alert("语音通话功能开发中...")}function _t(){!s.isRecording||s.activeMode!=="asr"||(s.discardRecording=!0,se(!1))}function Rt(){!s.isRecording||s.activeMode!=="asr"||(s.discardRecording=!1,se(!0))}async function kt(){if(s.processing)return;if(s.isRecording){se(!0);return}if(R(),C(),ke()==="local"){if(!O){s.localUnavailableAlerted||(alert("当前浏览器不支持本地语音识别，将改用云端 ASR"),s.localUnavailableAlerted=!0),z("asr"),await de();return}if(ct())return;s.localUnavailableAlerted||(alert("无法启动本地语音识别，将使用云端 ASR。"),s.localUnavailableAlerted=!0),z("asr"),await de();return}await de()}document.addEventListener("DOMContentLoaded",()=>{Ie().then(()=>{var c,m;Ze(),ee(),F(),ie(),te(),p&&K(p.id),j(),ae(),Ve({currentTarget:document.querySelector(".settings-menu .menu-item")},"characters"),Oe(),C();const e=document.getElementById("historySearch");e==null||e.addEventListener("input",()=>{F()}),(c=document.querySelectorAll(".avatar-mode-btn"))==null||c.forEach(d=>{d.addEventListener("click",()=>{const u=d.getAttribute("data-avatar-mode");u&&ye(u)})});const t=document.getElementById("characterEmoji");t==null||t.addEventListener("input",d=>{g.emoji=d.target.value,q()});const n=document.getElementById("characterAvatarUrl");n==null||n.addEventListener("input",d=>{g.url=d.target.value,q()});const a=document.getElementById("characterAvatarFile");a==null||a.addEventListener("change",at),(m=document.getElementById("voiceModeToggle"))==null||m.addEventListener("click",it),document.body.setAttribute("data-theme","light"),localStorage.setItem("theme","light");const o=document.getElementById("currentCharacterAvatar");o==null||o.addEventListener("click",d=>{d.stopPropagation();const u=document.getElementById("roleDropdown");if(u){const v=o.getBoundingClientRect(),f=document.querySelector(".chat-header").getBoundingClientRect();u.style.left=`${v.left-f.left}px`,u.style.top=`${v.bottom-f.top+8}px`}Ae()});const i=document.getElementById("roleNameButton");i==null||i.addEventListener("click",d=>{d.stopPropagation();const u=document.getElementById("roleDropdown");if(u){const v=i.getBoundingClientRect(),f=document.querySelector(".chat-header").getBoundingClientRect();u.style.left=`${v.left-f.left}px`,u.style.top=`${v.bottom-f.top+8}px`}Ae()}),document.addEventListener("click",d=>{const u=document.getElementById("roleDropdown");if(!u||u.classList.contains("hidden"))return;const v=document.getElementById("currentCharacterAvatar"),f=document.getElementById("roleNameButton");u.contains(d.target)||v!=null&&v.contains(d.target)||f!=null&&f.contains(d.target)||De()});const l=document.getElementById("characterForm");l==null||l.addEventListener("submit",d=>{d.preventDefault();const u={name:document.getElementById("characterName").value,description:document.getElementById("characterDesc").value,personality:document.getElementById("characterPersonality").value,background:document.getElementById("characterBackground").value,responseFormat:document.getElementById("characterFormat").value,openingMessage:document.getElementById("characterOpening").value},v=ot();if(u.icon=v.icon||u.icon||"🧑",u.avatarType=v.avatarType,u.avatarUrl=v.avatarUrl,U){const f=y.find(h=>h.id===U);if(f){Object.assign(f,u);const h=S[f.id];h&&h.length&&(h[0]=Z(f,h[0].timestamp||Date.now()))}}else{const f={id:Date.now(),...u,createdAt:new Date().toISOString().split("T")[0],lastActive:"刚刚",conversationCount:0};y.push(f),S[f.id]=[Z(f)],p=f,U=null}oe(y),ee(),F(),te(),p&&K(p.id),j(),ae(),Ne(),U=null})})});window.showSettings=Mt;window.showChat=St;window.showSettingsTab=Ve;window.showAddCharacterModal=$t;window.editCharacter=Bt;window.deleteCharacter=At;window.closeCharacterModal=Ne;window.sendMessage=He;window.handleKeyPress=Et;window.attachFile=Lt;window.startVoiceCall=xt;window.startVoiceInput=kt;window.cancelVoiceRecording=_t;window.finishVoiceRecording=Rt;window.setTheme=e=>{document.body.setAttribute("data-theme",e),localStorage.setItem("theme",e)};window.newConversation=()=>{if(!p)return;const e=p.id;A&&A.charId===e&&(A=null);const t=S[e]||[];k[e]=k[e]||[],t&&t.length>0&&k[e].push({id:`${e}-${Date.now()}`,messages:t}),S[e]=[Z(p)],A=null,K(e),F()};
