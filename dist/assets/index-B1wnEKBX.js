(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(s){if(s.ep)return;s.ep=!0;const o=n(s);fetch(s.href,o)}})();const He=[{id:1,name:"智慧导师",icon:"🧙",description:"博学多才，善于解答各种问题",personality:"耐心、睿智、温和",background:"来自古老图书馆的智慧守护者，擅长将复杂知识拆解为可执行方案。",responseFormat:"回答包含背景、分析和行动建议三个段落。",avatarType:"pixel",avatarUrl:"",openingMessage:"你好！我是智慧导师，很高兴与你讨论任何问题。请告诉我你想探索的方向。",createdAt:"2024-01-15",lastActive:"刚刚",conversationCount:45},{id:2,name:"创意助手",icon:"🎨",description:"富有想象力，擅长创意和设计",personality:"活泼、创新、艺术感强",background:"常驻创意实验室，熟悉视觉艺术、品牌设计与叙事构建。",responseFormat:"先给一个灵感主题，再给三个可执行创意点子。",avatarType:"pixel",avatarUrl:"",openingMessage:"嗨！我是创意助手，随时准备一起头脑风暴。说说你脑海中的想法吧！",createdAt:"2024-01-10",lastActive:"5分钟前",conversationCount:38},{id:3,name:"商业顾问",icon:"💼",description:"专业商务，擅长策略分析和市场规划",personality:"理性、专业、目标导向",background:"来自国际咨询公司，熟悉市场分析、运营优化与财务模型。",responseFormat:"使用数字编号列出洞察、风险和行动建议。",avatarType:"pixel",avatarUrl:"",openingMessage:"您好，我是商业顾问。欢迎分享您的业务挑战，我们可以先明确目标再逐步分析。",createdAt:"2024-01-05",lastActive:"1小时前",conversationCount:44}],Ee="app_characters";function Oe(e){return e.map(t=>({...t}))}function Ie(e,t){const n=(e==null?void 0:e.avatarType)||(e!=null&&e.avatarUrl?"url":e!=null&&e.icon?"emoji":"pixel"),a=(e==null?void 0:e.avatarUrl)||"",s=typeof(e==null?void 0:e.icon)=="string"?e.icon:"";return{id:(e==null?void 0:e.id)??Date.now()+t,name:(e==null?void 0:e.name)||`角色${t+1}`,icon:s||"🧑",description:(e==null?void 0:e.description)||"",personality:(e==null?void 0:e.personality)||"",background:(e==null?void 0:e.background)||"",responseFormat:(e==null?void 0:e.responseFormat)||"",openingMessage:(e==null?void 0:e.openingMessage)||"",avatarType:n,avatarUrl:a,createdAt:(e==null?void 0:e.createdAt)||new Date().toISOString().split("T")[0],lastActive:(e==null?void 0:e.lastActive)||"刚刚",conversationCount:(e==null?void 0:e.conversationCount)||0}}function ee(e){try{localStorage.setItem(Ee,JSON.stringify(e))}catch{}}function Ne(){try{const e=localStorage.getItem(Ee);if(!e)return null;const t=JSON.parse(e);return!Array.isArray(t)||!t.length?null:t.map((n,a)=>Ie(n,a))}catch{return null}}function Pe(){const e=Ne();if(e)return e;const t=Oe(He).map((n,a)=>Ie(n,a));return ee(t),t}let h=Pe(),v=h[0]||null,$={},k={},B=null,N=null;const Ve="admin_character_prompts";let f={mode:"emoji",emoji:"",url:"",uploadData:"",uploadName:"",baseCharacter:null};const m={isRecording:!1,processing:!1,recognition:null,mediaRecorder:null,mediaStream:null,chunks:[],baseText:"",lastPartial:""};function Ue(e=""){var o;const t=[],n=/<think>([\s\S]*?)<\/think>/gi;let a=e,s=n.exec(e);for(;s;){const i=(o=s[1])==null?void 0:o.trim();i&&t.push(i),s=n.exec(e)}return a=e.replace(n,"").trim(),{cleanedText:a,thinkSegments:t}}function T(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function oe(e=""){return T(e).replace(/\"/g,"&quot;").replace(/'/g,"&#39;")}function H(e,t=40){const n=Number.isFinite(t)?Math.max(24,t):40,a=`style="width:${n}px;height:${n}px;"`;if(!e)return`<div class="avatar-chip" ${a}><span class="avatar-emoji" style="font-size:${Math.round(n*.6)}px;">🖼️</span></div>`;const s=e.avatarType,o=e.avatarUrl;if((s==="url"||s==="upload")&&o)return`<div class="avatar-chip" ${a}><img src="${oe(o)}" alt="${oe(e.name||"avatar")}" /></div>`;if((s==="emoji"||!s&&e.icon)&&e.icon)return`<div class="avatar-chip" ${a}><span class="avatar-emoji" style="font-size:${Math.round(n*.6)}px;">${T(e.icon)}</span></div>`;const i=ot(e.name||"");return`<div class="avatar-chip avatar-pixel-wrapper" ${a}>${i}</div>`}let le=!1;function he(e){le=e;const t=document.getElementById("messageInput"),n=document.querySelector(".send-btn");if(t)if(t.disabled=e,e)t.setAttribute("data-prev-ph",t.getAttribute("placeholder")||""),t.setAttribute("placeholder","正在生成回复…");else{const a=t.getAttribute("data-prev-ph");a!==null&&t.setAttribute("placeholder",a)}n&&(n.disabled=e)}function J(e,t=Date.now()){const n=(e==null?void 0:e.openingMessage)&&e.openingMessage.trim()||`你好！我是${(e==null?void 0:e.name)||"伙伴"}，很高兴与你交流。`;return{type:"ai",author:(e==null?void 0:e.name)||"AI",text:n,time:ie(t),timestamp:t}}function Fe(){h.length&&h.forEach((e,t)=>{const a=it(e.lastActive)??Date.now()-t*5*60*1e3;$[e.id]=[J(e,a)],k[e.id]=[]})}function qe(e){if(!e)return"";try{const t=localStorage.getItem(Ve);if(!t)return"";const n=JSON.parse(t);if(n&&typeof n=="object"){const a=n[e]??n[Number(e)]??null;return a?typeof a=="string"?a:(a==null?void 0:a.prompt)||"":""}return""}catch{return""}}function ze(e){if(!e)return"";const t=[],n=qe(e.id);return n&&t.push(n),e.description&&t.push(`角色定位：
${e.description}`),e.personality&&t.push(`性格特征：
${e.personality}`),e.background&&t.push(`背景信息：
${e.background}`),e.responseFormat&&t.push(`回答格式要求：
${e.responseFormat}`),t.join(`

`).trim()}function je(e,t){const n=[],a=ze(t);return a&&n.push({role:"system",content:a}),n.push({role:"user",content:e}),n}function Ke(){const e=document.querySelector(".avatar-upload-hint");if(!e)return;e.dataset.defaultHint||(e.dataset.defaultHint=e.textContent);const t=f.uploadData&&f.uploadName?`已选择：${f.uploadName}`:e.dataset.defaultHint;e.textContent=t;const n=document.querySelector(".avatar-upload-btn span");n&&(n.textContent=f.uploadData?"重新选择图片":"选择图片")}function Ge(){if(f.mode==="emoji"&&f.emoji.trim())return{type:"emoji",value:f.emoji.trim()};if(f.mode==="url"&&f.url.trim())return{type:"image",value:f.url.trim()};if(f.mode==="upload"&&f.uploadData)return{type:"image",value:f.uploadData};const e=f.baseCharacter;if(e){if((e.avatarType==="url"||e.avatarType==="upload")&&e.avatarUrl)return{type:"image",value:e.avatarUrl};if(e.avatarType==="emoji"&&e.icon)return{type:"emoji",value:e.icon}}return{type:"placeholder",value:"🖼️"}}function V(){const e=document.getElementById("avatarPreview");if(!e)return;const t=Ge();t.type==="image"?e.innerHTML=`<div class="avatar-img-wrapper"><img src="${oe(t.value)}" alt="头像预览" /></div>`:t.type==="emoji"?e.innerHTML=`<span class="avatar-emoji">${T(t.value)}</span>`:e.innerHTML=`<span class="placeholder">${T(t.value)}</span>`,Ke()}function ce(e,t=!0){f.mode=e,document.querySelectorAll(".avatar-mode-btn").forEach(n=>{n.classList.toggle("active",n.dataset.avatarMode===e)}),document.querySelectorAll(".avatar-input-field").forEach(n=>{const s=n.getAttribute("data-avatar-field")===e;if(n.classList.toggle("hidden",!s),s&&t){const o=n.querySelector('input:not([type="file"])');o==null||o.focus()}}),V()}function Je(e){var a,s;const t=(s=(a=e.target)==null?void 0:a.files)==null?void 0:s[0];if(!t){f.uploadData="",f.uploadName="",V();return}const n=new FileReader;n.onload=o=>{var i;f.uploadData=((i=o.target)==null?void 0:i.result)||"",f.uploadName=t.name||"",ce("upload",!1),V()},n.readAsDataURL(t)}function Te(e){f={mode:"emoji",emoji:"",url:"",uploadData:"",uploadName:"",baseCharacter:e||null},e&&(e.avatarType==="url"?(f.mode="url",f.url=e.avatarUrl||""):e.avatarType==="upload"?(f.mode="upload",f.uploadData=e.avatarUrl||"",f.uploadName=e.avatarUrl?"已保存图片":""):e.avatarType==="emoji"?(f.mode="emoji",f.emoji=e.icon||""):e.icon&&(f.mode="emoji",f.emoji=e.icon));const t=document.getElementById("characterEmoji");t&&(t.value=f.emoji||"");const n=document.getElementById("characterAvatarUrl");n&&(n.value=f.url||"");const a=document.getElementById("characterAvatarFile");a&&(a.value=""),ce(f.mode,!1),V()}function We(){var a,s;const e=(a=f.emoji)==null?void 0:a.trim(),t=(s=f.url)==null?void 0:s.trim();if(f.mode==="emoji"&&e)return{avatarType:"emoji",avatarUrl:"",icon:e};if(f.mode==="url"&&t)return{avatarType:"url",avatarUrl:t,icon:""};if(f.mode==="upload"&&f.uploadData)return{avatarType:"upload",avatarUrl:f.uploadData,icon:""};const n=f.baseCharacter;return n?{avatarType:n.avatarType||"emoji",avatarUrl:n.avatarUrl||"",icon:n.icon||""}:{avatarType:"emoji",avatarUrl:"",icon:e||"🙂"}}function se(e){return e!=null&&e.length?`
    <details class="think-block">
      <summary>
        <span class="think-icon">🧠</span>
        <span class="think-label">查看思考内容</span>
        <span class="think-chevron">▾</span>
      </summary>
      <div class="think-body">${e.map(n=>`<div class="think-item">${ue(n)}</div>`).join("")}</div>
    </details>
  `:""}function Ye(){var t;const e=localStorage.getItem("cfg_asr_model");if(e)return e;try{const n=localStorage.getItem("visible_asr_models");if(n){const a=JSON.parse(n);if(Array.isArray(a)&&a.length)return a[0]}}catch(n){console.warn("解析可见 ASR 模型失败",n)}return(t=r==null?void 0:r.defaults)!=null&&t.asr&&r.defaults.asr.length?r.defaults.asr[0]:""}function x(){const e=document.querySelector('[data-action="voice"]');e&&(e.classList.toggle("recording",m.isRecording),e.classList.toggle("loading",m.processing),e.setAttribute("aria-pressed",m.isRecording?"true":"false"),e.disabled=m.processing)}function ye(e){m.processing=e,x()}function W(e,t=!1){const n=document.getElementById("messageInput");if(!n)return;const a=(e||"").trim();if(t)m.baseText=[m.baseText,a].filter(Boolean).join(" ").trim(),m.lastPartial="",n.value=m.baseText;else{m.lastPartial=a;const s=[m.baseText,m.lastPartial].filter(Boolean).join(" ").trim();n.value=s}n.focus()}function re(){var e;m.mediaStream&&((e=m.mediaStream.getTracks())==null||e.forEach(t=>t.stop())),m.mediaStream=null}function Me(e=!0){if(m.isRecording){if(m.recognition){const t=m.recognition;m.recognition=null,t.stop(),m.isRecording=!1,e&&m.lastPartial&&W(m.lastPartial,!0),x();return}if(m.mediaRecorder)try{m.mediaRecorder.stop()}catch(t){console.warn("停止录音失败",t)}re(),m.isRecording=!1,x()}}async function Ze(e){var t,n,a,s,o,i;if(!(!e||!e.size)){ye(!0);try{await me();const l=localStorage.getItem("dev_enabled")==="true",c=Ye(),d=new FormData;d.append("file",e,`recording-${Date.now()}.webm`),c&&d.append("model",c);let u="";const g={};if(l){const y=localStorage.getItem("dev_asr_base")||((t=r==null?void 0:r.dev)==null?void 0:t.asrBase)||((n=r==null?void 0:r.dev)==null?void 0:n.llmBase);if(!y)throw new Error("未配置 ASR Base 地址");const _=((a=r==null?void 0:r.dev)==null?void 0:a.asrTranscribeEndpoint)||"/v1/audio/transcriptions";u=`${y}${_}`;const I=localStorage.getItem("dev_asr_key");if(I){const M=((s=r==null?void 0:r.dev)==null?void 0:s.authHeader)||"Authorization",S=((o=r==null?void 0:r.dev)==null?void 0:o.authScheme)||"Bearer";g[M]=`${S} ${I}`}}else{const y=(r==null?void 0:r.apiBase)||"",_=(r==null?void 0:r.asrRoute)||"/asr/transcribe";u=`${y}${_}`}const p=await fetch(u,{method:"POST",headers:g,body:d});if(!p.ok){const y=await p.text().catch(()=>"");throw new Error(y||`HTTP ${p.status}`)}const w=await p.json().catch(()=>({})),E=w.text||w.transcript||w.result||((i=w.data)==null?void 0:i.text)||"";E?W(E,!0):alert("未获取到识别结果")}catch(l){console.error("ASR 请求失败",l),alert(`语音识别失败：${(l==null?void 0:l.message)||l}`)}finally{ye(!1)}}}function Xe(){var t;const e=window.SpeechRecognition||window.webkitSpeechRecognition;if(!e)return!1;try{const n=new e;return n.lang=navigator.language||"zh-CN",n.interimResults=!0,n.continuous=!0,m.baseText=(((t=document.getElementById("messageInput"))==null?void 0:t.value)||"").trim(),m.lastPartial="",n.onresult=a=>{var i;let s="",o="";for(let l=a.resultIndex;l<a.results.length;l+=1){const c=a.results[l];if(!c)continue;const d=((i=c[0])==null?void 0:i.transcript)||"";c.isFinal?o+=d:s+=d}s&&W(s,!1),o&&W(o,!0)},n.onerror=a=>{console.error("SpeechRecognition error",a),alert(`语音识别错误：${(a==null?void 0:a.error)||"未知错误"}`),Me(!1)},n.onend=()=>{m.recognition=null,m.isRecording=!1,x()},n.start(),m.recognition=n,m.isRecording=!0,x(),!0}catch(n){return console.warn("SpeechRecognition 启动失败",n),!1}}async function Qe(){var e,t;try{if(!((e=navigator.mediaDevices)!=null&&e.getUserMedia))throw new Error("当前浏览器不支持麦克风采集");const n=await navigator.mediaDevices.getUserMedia({audio:!0}),a=MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?"audio/webm;codecs=opus":"audio/webm",s=new MediaRecorder(n,{mimeType:a});m.mediaRecorder=s,m.mediaStream=n,m.chunks=[],m.baseText=(((t=document.getElementById("messageInput"))==null?void 0:t.value)||"").trim(),m.lastPartial="",s.addEventListener("dataavailable",o=>{o.data&&o.data.size>0&&m.chunks.push(o.data)}),s.addEventListener("stop",async()=>{const o=new Blob(m.chunks,{type:s.mimeType});re(),m.mediaRecorder=null,m.isRecording=!1,x(),m.chunks=[],o.size>0&&await Ze(o)}),s.start(),m.isRecording=!0,x()}catch(n){console.error("启动 MediaRecorder 失败",n),alert(`无法访问麦克风：${(n==null?void 0:n.message)||n}`),re(),m.mediaRecorder=null,m.isRecording=!1,x()}}function et(e){if(!e)return null;const t=e.split(/\n+/).map(o=>o.trim()).filter(Boolean);if(t.length<4)return null;const n=/^([A-Za-z\u4e00-\u9fa5]{1,16})(?:[:：])?$/,a=[];let s=null;return t.forEach(o=>{n.test(o)&&o.length<=10?(s&&a.push(s),s={title:o.replace(/[:：]$/,""),body:[]}):(s||(s={title:"思考",body:[]}),s.body.push(o))}),s&&a.push(s),a.length<2?null:a}function tt(e){const t=et(e);if(!t)return null;const n={背景:"🗺️",角色:"🧍",思考:"🧠",分析:"🔍",计划:"🗒️",策略:"🧭",行动建议:"✅",建议:"✅",结果:"📌",总结:"📘"},a=["🧠","🔍","✅","💡","🗺️"];let s=0;return`<div class="reasoning-bubble">${t.map(i=>{const l=n[i.title]||a[s++%a.length],c=i.body.join(`
`),d=ue(c);return`
        <div class="reasoning-section">
          <div class="reasoning-title"><span class="reasoning-icon">${l}</span><span>${T(i.title)}</span></div>
          <div class="reasoning-body">${d}</div>
        </div>
      `}).join("")}</div>`}function nt(){return`
  <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
    <rect x="6" y="1" width="4" height="2" fill="#5d4037"/>
    <rect x="5" y="3" width="6" height="2" fill="#5d4037"/>
    <rect x="4" y="5" width="8" height="1" fill="#5d4037"/>
    <rect x="3" y="6" width="10" height="1" fill="#5d4037"/>
    <rect x="6" y="7" width="4" height="3" fill="#f3c26b"/>
    <rect x="5" y="10" width="6" height="4" fill="#6a1b9a"/>
    <rect x="11" y="9" width="1" height="5" fill="#2e7d32"/>
    <rect x="12" y="9" width="1" height="1" fill="#a5d6a7"/>
  </svg>`}function at(){return`
  <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
    <rect x="6" y="6" width="4" height="3" fill="#f3c26b"/>
    <rect x="5" y="9" width="6" height="5" fill="#8e44ad"/>
    <rect x="9" y="4" width="3" height="2" fill="#7f8c8d"/>
    <rect x="3" y="10" width="3" height="2" fill="#c49b6e"/>
    <rect x="3" y="10" width="1" height="1" fill="#e74c3c"/>
    <rect x="4" y="11" width="1" height="1" fill="#3498db"/>
    <rect x="5" y="10" width="1" height="1" fill="#f1c40f"/>
  </svg>`}function st(){return`
  <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
    <rect x="6" y="6" width="4" height="3" fill="#f3c26b"/>
    <rect x="5" y="9" width="6" height="5" fill="#34495e"/>
    <rect x="7" y="11" width="2" height="2" fill="#ecf0f1"/>
    <rect x="6" y="4" width="4" height="2" fill="#7f8c8d"/>
  </svg>`}function Se(){return`
  <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
    <rect x="6" y="6" width="4" height="3" fill="#f3c26b"/>
    <rect x="5" y="9" width="6" height="5" fill="#6d4c41"/>
  </svg>`}function ot(e){return e==="智慧导师"?nt():e==="创意助手"?at():e==="商业顾问"?st():Se()}function ie(e){return new Date(e).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})}function rt(e){const t=Date.now()-e,n=60*1e3,a=60*n,s=24*a;return t<n?"刚刚":t<a?`${Math.floor(t/n)}分钟前`:t<s?`${Math.floor(t/a)}小时前`:new Date(e).toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})}function it(e){if(!e)return;if(e.includes("刚刚"))return Date.now();const t=e.match(/(\d+)分钟/);if(t)return Date.now()-parseInt(t[1],10)*60*1e3;const n=e.match(/(\d+)小时/);if(n)return Date.now()-parseInt(n[1],10)*60*60*1e3}function P(){var a;const e=document.getElementById("historyList");if(!e)return;e.innerHTML="";const t=(((a=document.getElementById("historySearch"))==null?void 0:a.value)||"").trim().toLowerCase(),n=[];h.forEach(s=>{const o=$[s.id]||[];if(o.length){const i=o[o.length-1];n.push({type:"current",char:s,sessionId:"current",lastMsg:i,lastTs:i.timestamp})}(k[s.id]||[]).forEach(i=>{const l=i.messages[i.messages.length-1];n.push({type:"archived",char:s,sessionId:i.id,lastMsg:l,lastTs:(l==null?void 0:l.timestamp)||0})})}),n.sort((s,o)=>o.lastTs-s.lastTs),n.forEach(s=>{const{char:o,type:i,sessionId:l,lastMsg:c,lastTs:d}=s,u=d?rt(d):"",g=c?c.text:i==="archived"?"历史会话":"暂无对话";if(t&&!(o.name.toLowerCase().includes(t)||g.toLowerCase().includes(t)))return;const p=document.createElement("div");p.className="history-item",p.onclick=()=>{i==="archived"?lt(o.id,l):(B=null,de(o.id))},p.innerHTML=`
      <div class="history-main">
        <div class="history-title">
          <span class="history-name">${g}</span>
          <span class="history-time">${u}</span>
        </div>
      </div>
      <button class="history-del-btn" title="删除" aria-label="删除">
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
          <path d="M10 11v6"></path>
          <path d="M14 11v6"></path>
          <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>
        </svg>
      </button>
    `;const w=p.querySelector(".history-del-btn");w.onclick=E=>{E.stopPropagation(),ct(o.id,i,l)},e.appendChild(p)})}function lt(e,t){const n=document.getElementById("chatMessages");if(!n)return;n.innerHTML="";const a=(k[e]||[]).find(s=>s.id===t);a&&(B={charId:e,sessionId:t},a.messages.forEach(s=>X(s)))}function ct(e,t,n){if(window.confirm("确定删除该对话吗？删除后无法恢复")){if(t==="archived"){if(k[e]=(k[e]||[]).filter(s=>s.id!==n),B&&B.charId===e&&B.sessionId===n){B=null;const s=document.getElementById("chatMessages");s&&(s.innerHTML="")}}else if($[e]=[],!B&&v&&v.id===e){const s=document.getElementById("chatMessages");s&&(s.innerHTML="")}P()}}function te(){const e=document.getElementById("roleDropdown");if(!e)return;e.innerHTML="";const t=v==null?void 0:v.id;h.forEach(n=>{const a=document.createElement("div");a.className=`model-item ${t&&n.id===t?"active":""}`;const s=H(n,36);a.innerHTML=`
      <div class="avatar">${s}</div>
      <div class="name">${T(n.name)}</div>
    `,a.onclick=()=>{de(n.id),$e();const o=document.getElementById("roleSwitcherLabel");o&&(o.textContent=v.name);const i=document.getElementById("currentCharacterAvatar");i&&(i.classList.remove("pulse"),i.offsetWidth,i.classList.add("pulse"))},e.appendChild(a)})}function we(){const e=document.getElementById("roleDropdown");e&&(e.classList.contains("hidden")?(te(),e.classList.remove("hidden"),e.classList.add("show")):(e.classList.remove("show"),e.classList.add("hidden")))}function $e(){const e=document.getElementById("roleDropdown");e==null||e.classList.add("hidden")}function Y(){const e=document.getElementById("characterList");e&&(e.innerHTML="",h.forEach(t=>{const n=document.createElement("div"),a=v&&t.id===v.id;n.className=`character-item ${a?"active":""}`,n.onclick=()=>de(t.id);const s=H(t);n.innerHTML=`
      <div class="character-header">
        <div class="character-avatar">${s}</div>
        <div class="character-name">${T(t.name)}</div>
      </div>
      <div class="character-desc">${T(t.description)}</div>
      <div style="font-size: 10px; color: #8b4513; margin-top: 5px;">
        最后对话：${T(t.lastActive)}
      </div>
    `,e.appendChild(n)}))}function Z(){const e=document.getElementById("characterManagement");e&&(e.innerHTML="",h.forEach(t=>{const n=document.createElement("div");n.className="character-card";const a=H(t,60);n.innerHTML=`
      <div class="character-avatar" style="width: 60px; height: 60px;">${a}</div>
      <div class="character-card-info">
        <h3>${T(t.name)}</h3>
        <p>描述：${T(t.description)}</p>
        <p>性格：${T(t.personality)}</p>
        ${t.background?`<p>背景：${T(t.background)}</p>`:""}
        ${t.responseFormat?`<p>回答格式：${T(t.responseFormat)}</p>`:""}
        <div class="meta">创建时间：${T(t.createdAt)}</div>
      </div>
      <div class="character-actions">
        <button class="btn btn-small btn-edit" onclick="editCharacter(${t.id})">编辑</button>
        <button class="btn btn-small btn-delete" onclick="deleteCharacter(${t.id})">删除</button>
      </div>
    `,e.appendChild(n)}))}function U(){const e=document.getElementById("currentCharacterAvatar"),t=document.getElementById("currentCharacterName");if(!v){e&&(e.innerHTML=H(null,48)),t&&(t.textContent="");return}e&&(e.innerHTML=H(v,48)),t&&(t.textContent=v.name)}function de(e){const t=h.find(n=>n.id===e);t&&(v=t,Y(),te(),F(e),U())}function F(e){const t=document.getElementById("chatMessages");if(!t)return;t.innerHTML="",($[e]||[]).forEach(a=>{X(a)}),t.scrollTop=t.scrollHeight}function X(e){const t=document.getElementById("chatMessages");if(!t)return;const n=document.createElement("div");n.className=`message ${e.type}`;const a=e.type==="ai"?H(v,36):`<div class="avatar-chip" style="width:36px;height:36px;">${Se()}</div>`,s=t.lastElementChild;if(s&&s.classList.contains(e.type)&&n.classList.add("grouped"),e.type==="ai"){const{cleanedText:i,thinkSegments:l}=Ue(e.text);n.innerHTML=`
      <div class="message-avatar">${a}</div>
      <div class="message-content"><div class="message-text"></div></div>
      <div class="message-time outside">${e.time}</div>
    `;try{const c=n.querySelector(".message-text");if(c){const d=tt(i);d?(n.classList.add("ai-reasoning"),c.innerHTML=d,l.length&&c.insertAdjacentHTML("beforeend",se(l))):(c.innerHTML=ue(i||""),l.length&&c.insertAdjacentHTML("beforeend",se(l)))}}catch{const d=n.querySelector(".message-text");d&&(d.textContent=i||e.text,l.length&&d.insertAdjacentHTML("beforeend",se(l)))}}else{n.innerHTML=`
      <div class="message-time outside">${e.time}</div>
      <div class="message-content"><div class="message-text"></div></div>
      <div class="message-avatar">${a}</div>
    `;const i=n.querySelector(".message-text");i.textContent=e.text}t.appendChild(n)}function Be(){if(!v||le)return;const e=document.getElementById("messageInput");if(!e)return;const t=e.value.trim();if(!t)return;const n=Date.now(),a={type:"user",text:t,time:ie(n),timestamp:n};B=null,$[v.id]=$[v.id]||[],$[v.id].push(a),X(a),e.value="",be(),he(!0);const s=document.getElementById("chatMessages"),o=document.createElement("div");o.className="message ai typing",o.innerHTML=`
    <div class="message-avatar">${H(v,36)}</div>
    <div class="message-content"><div class="typing-dots"><span></span><span></span><span></span></div></div>
  `,s.appendChild(o),setTimeout(()=>{const i=c=>{const d=Date.now(),u={type:"ai",author:v.name,text:c,time:ie(d),timestamp:d};o.remove(),$[v.id].push(u),X(u);const g=document.getElementById("chatMessages");g&&(g.scrollTop=g.scrollHeight),be(),he(!1)},l=je(t,v);localStorage.getItem("dev_enabled")==="true"?me().then(()=>{r.dev=r.dev||{},r.dev.enabled=!0,r.dev.llmBase=localStorage.getItem("dev_llm_base")||r.dev.llmBase,localStorage.getItem("dev_api_key");let c="";ut(l,d=>{c+=d;const u=o.querySelector(".message-content");u&&(u.innerHTML=c);const g=document.getElementById("chatMessages");g&&(g.scrollTop=g.scrollHeight)},()=>{i(c||"")},d=>{const u=typeof d=="string"?d:(d==null?void 0:d.message)||"未知错误";i(`调用失败：${u}`)})}):i(dt(t,v))},1e3)}function dt(e,t){const a={智慧导师:["这是一个很有趣的问题，让我来为你详细解答。","从我的经验来看，这个问题有几个关键点需要考虑。","你提出了一个很好的观点，我建议你可以从以下几个方面深入思考。"],创意助手:["哇！这个想法太有创意了！我有一些更有趣的建议给你。","让我发挥一下想象力，我觉得可以这样设计...","这个概念很棒！我们可以加入更多创新的元素。"],商业顾问:["从商业角度分析，这个方案有几个优势和需要注意的风险。","根据市场调研数据，我建议采用以下策略来优化这个项目。","这个投资机会看起来很有潜力，但我们需要仔细评估ROI。"]}[t.name]||["这是一个很好的问题，让我为你分析一下。"];return a[Math.floor(Math.random()*a.length)]}function ue(e){if(!e)return"";let t=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");const n=[];return t=t.replace(/```([a-zA-Z0-9_-]+)?\n([\s\S]*?)```/g,(a,s,o)=>{const i=`__CODE_${n.length}__`;return n.push(`<pre><code class="lang-${s||"plain"}">${o}</code></pre>`),i}),t=t.replace(/^######\s+(.+)$/gm,"<h6>$1</h6>").replace(/^#####\s+(.+)$/gm,"<h5>$1</h5>").replace(/^####\s+(.+)$/gm,"<h4>$1</h4>").replace(/^###\s+(.+)$/gm,"<h3>$1</h3>").replace(/^##\s+(.+)$/gm,"<h2>$1</h2>").replace(/^#\s+(.+)$/gm,"<h1>$1</h1>"),t=t.replace(/^>\s+(.+)$/gm,"<blockquote>$1</blockquote>"),t=t.replace(/^(?:\-|\*)\s+(.+)$/gm,"<li>$1</li>"),t=t.replace(/(?:<li>.*<\/li>\n?)+/gs,a=>`<ul>${a}</ul>`),t=t.replace(/^(\d+)\.\s+(.+)$/gm,"<li>$2</li>"),t=t.replace(/(?:<li>.*<\/li>\n?)+/gs,a=>a.startsWith("<ul>")?a:`<ol>${a}</ol>`),t=t.replace(/\[([^\]]+)\]\((https?:[^)\s]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'),t=t.replace(/`([^`]+)`/g,"<code>$1</code>"),t=t.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),t=t.replace(new RegExp("(?<!\\*)\\*(?!\\*)(.+?)(?<!\\*)\\*(?!\\*)","g"),"<em>$1</em>"),t=t.replace(/^(-{3,}|\*{3,})$/gm,"<hr/>"),t=t.replace(/(^|\n)(?!<(h\d|ul|ol|li|pre|blockquote|hr|p|code))([^\n]+)(?=\n|$)/g,(a,s,o,i)=>`${s}<p>${i}</p>`),n.forEach((a,s)=>{t=t.replace(`__CODE_${s}__`,a)}),t}async function ut(e,t,n,a){var g,p,w,E,y,_,I,M,S,L,q;const s=new AbortController,o=2e4,i=12e4;let l=null,c=null;const d=()=>{l&&clearTimeout(l),l=setTimeout(()=>{s.abort("idle-timeout")},o)},u=()=>{l&&clearTimeout(l),c&&clearTimeout(c),l=null,c=null};try{const A=localStorage.getItem("dev_llm_base")||((g=r==null?void 0:r.dev)==null?void 0:g.llmBase),C=localStorage.getItem("dev_api_key")||"",R=localStorage.getItem("cfg_llm_model")||((w=(p=r.defaults)==null?void 0:p.llm)==null?void 0:w[0])||"",O=Array.isArray(e)&&e.length?e:[{role:"user",content:typeof e=="string"?e:""}];if(!A||!C||!R)throw new Error("缺少 base/key/model");const z=((E=r==null?void 0:r.dev)==null?void 0:E.authHeader)||"Authorization",j=((y=r==null?void 0:r.dev)==null?void 0:y.authScheme)||"Bearer";c=setTimeout(()=>s.abort("hard-timeout"),i),d();const b=await fetch(`${A}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"text/event-stream",[z]:`${j} ${C}`},body:JSON.stringify({model:R,stream:!0,messages:O}),signal:s.signal});if(!b.ok){const ae=await b.text();throw new Error(ae||`HTTP ${b.status}`)}const K=b.body.getReader(),Ae=new TextDecoder;let ne="";for(;;){const{value:ae,done:ke}=await K.read();if(ke)break;d(),ne+=Ae.decode(ae,{stream:!0});const ge=ne.split(/\r?\n\r?\n/);ne=ge.pop();for(const Ce of ge){const Re=Ce.split(/\r?\n/).filter(Boolean);for(const De of Re){const fe=De.replace(/\r$/,"").match(/^data:\s*(.*)$/);if(!fe)continue;const ve=(fe[1]||"").trim();if(ve==="[DONE]"){u(),n&&n();return}try{const D=JSON.parse(ve),pe=((M=(I=(_=D==null?void 0:D.choices)==null?void 0:_[0])==null?void 0:I.delta)==null?void 0:M.content)||((q=(L=(S=D==null?void 0:D.choices)==null?void 0:S[0])==null?void 0:L.message)==null?void 0:q.content)||"";pe&&t&&t(pe)}catch{}}}}u(),n&&n()}catch(A){u(),a&&a(A)}}function mt(e){e.key==="Enter"&&(e.preventDefault(),le||Be())}function gt(){const e=document.getElementById("chatInterface"),t=document.getElementById("settingsInterface");e==null||e.classList.remove("active"),t==null||t.classList.add("active")}function ft(){const e=document.getElementById("chatInterface"),t=document.getElementById("settingsInterface");t==null||t.classList.remove("active"),e==null||e.classList.add("active")}function _e(e,t){var a;document.querySelectorAll(".menu-item").forEach(s=>s.classList.remove("active")),e.currentTarget.classList.add("active");const n={characters:document.getElementById("panel-characters"),models:document.getElementById("panel-models")};Object.values(n).forEach(s=>s==null?void 0:s.classList.add("hidden")),(a=n[t])==null||a.classList.remove("hidden")}let r=null;function me(){return r?Promise.resolve(r):fetch("/app-config.json",{cache:"no-store"}).then(e=>e.json()).then(e=>r=e).catch(()=>r={defaults:{}})}function G(e,t){var s,o,i,l;const a={VITE_LLM_MODELS:(s=r==null?void 0:r.defaults)==null?void 0:s.llm,VITE_ASR_MODELS:(o=r==null?void 0:r.defaults)==null?void 0:o.asr,VITE_TTS_VOICES:(i=r==null?void 0:r.defaults)==null?void 0:i.ttsVoices,VITE_VOICE_MODELS:(l=r==null?void 0:r.defaults)==null?void 0:l.voiceModels}[e];return Array.isArray(a)&&a.length?a:t}function vt(){const e=G("VITE_LLM_MODELS",["gpt-4o-mini","claude-3.5-haiku","qwen2.5-14b"]),t=G("VITE_ASR_MODELS",["deepgram:nova-2","whisper:large-v3","azure:speech"]),n=G("VITE_TTS_VOICES",["openai:alloy","elevenlabs:Rachel","azure:zh-CN-XiaoxiaoNeural"]),a=G("VITE_VOICE_MODELS",["openai:gpt-4o-realtime","deepgram:aura"]),s=(d,u)=>{try{const g=localStorage.getItem(d);return g?JSON.parse(g):u}catch{return u}},o=s("visible_llm_models",e).filter(Boolean),i=s("visible_asr_models",t).filter(Boolean),l=s("visible_tts_voices",n).filter(Boolean),c=s("visible_voice_models",a).filter(Boolean);return{llm:o,asr:i,ttsVoices:l,voiceModels:c}}function xe(){var a,s,o,i;const e=document.getElementById("panel-models");if(!e)return;const t=l=>{var y,_;const{llm:c,asr:d,ttsVoices:u,voiceModels:g}=l,p=(I,M)=>localStorage.getItem(I)||M,w={llm:p("cfg_llm_model",c[0]||""),asr:p("cfg_asr_model",d[0]||""),tts:p("cfg_tts_voice",u[0]||""),vrm:p("cfg_voice_model",g[0]||"")},E=(I,M)=>I.map(S=>`<option value="${S}" ${S===M?"selected":""}>${S}</option>`).join("");e.innerHTML=`
      <div class="form-section">
        <div class="form-row">
          <label>文本 LLM</label>
          <select id="sel-llm" class="select">${E(c,w.llm)}</select>
        </div>
        <div class="form-row">
          <label>ASR（语音识别）</label>
          <select id="sel-asr" class="select">${E(d,w.asr)}</select>
        </div>
        <div class="form-row">
          <label>TTS 声音</label>
          <select id="sel-tts" class="select">${E(u,w.tts)}</select>
        </div>
        <div class="form-row">
          <label>语音大模型</label>
          <select id="sel-vrm" class="select">${E(g,w.vrm)}</select>
        </div>
        <div class="form-actions">
          <button id="btn-save-models" class="btn">保存</button>
          <button id="btn-reset-models" class="btn btn-secondary">恢复默认</button>
        </div>
      </div>
    `,(y=document.getElementById("btn-save-models"))==null||y.addEventListener("click",()=>{const I=document.getElementById("sel-llm"),M=document.getElementById("sel-asr"),S=document.getElementById("sel-tts"),L=document.getElementById("sel-vrm");localStorage.setItem("cfg_llm_model",(I==null?void 0:I.value)||""),localStorage.setItem("cfg_asr_model",(M==null?void 0:M.value)||""),localStorage.setItem("cfg_tts_voice",(S==null?void 0:S.value)||""),localStorage.setItem("cfg_voice_model",(L==null?void 0:L.value)||""),alert("已保存模型与声音选择")}),(_=document.getElementById("btn-reset-models"))==null||_.addEventListener("click",()=>{localStorage.removeItem("cfg_llm_model"),localStorage.removeItem("cfg_asr_model"),localStorage.removeItem("cfg_tts_voice"),localStorage.removeItem("cfg_voice_model"),xe()})};t(vt());const n=(r==null?void 0:r.visibleModelsUrl)||"";if(n&&fetch(n).then(l=>l.json()).then(l=>{const c={llm:l.llm||l.llms||[],asr:l.asr||l.asrs||[],ttsVoices:l.ttsVoices||l.tts||[],voiceModels:l.voiceModels||l.vrm||[]};(c.llm.length||c.asr.length||c.ttsVoices.length||c.voiceModels.length)&&t(c)}).catch(()=>{}),localStorage.getItem("dev_enabled")==="true"){const l=localStorage.getItem("dev_llm_base")||((a=r==null?void 0:r.dev)==null?void 0:a.llmBase),c=localStorage.getItem("dev_api_key"),d=((s=r==null?void 0:r.dev)==null?void 0:s.modelsEndpoint)||"/models";l&&c&&fetch(`${l}${d}`,{headers:{[((o=r==null?void 0:r.dev)==null?void 0:o.authHeader)||"Authorization"]:`${((i=r==null?void 0:r.dev)==null?void 0:i.authScheme)||"Bearer"} ${c}`}}).then(u=>u.json()).then(u=>{var p,w,E;const g=Array.isArray(u==null?void 0:u.data)?u.data.map(y=>y.id).filter(Boolean):(u==null?void 0:u.models)||[];if(g.length){const y={llm:g,asr:[],ttsVoices:[],voiceModels:[]},_=localStorage.getItem("dev_asr_base")||l,I=localStorage.getItem("dev_asr_key")||c,M=localStorage.getItem("dev_tts_base")||l,S=localStorage.getItem("dev_tts_key")||c,L=localStorage.getItem("dev_vrm_base")||l,q=localStorage.getItem("dev_vrm_key")||c,A=(C,R,O)=>{var z,j;return!O||!C||!R?Promise.resolve([]):fetch(`${C}${O}`,{headers:{[((z=r==null?void 0:r.dev)==null?void 0:z.authHeader)||"Authorization"]:`${((j=r==null?void 0:r.dev)==null?void 0:j.authScheme)||"Bearer"} ${R}`}}).then(b=>b.json()).then(b=>Array.isArray(b==null?void 0:b.data)?b.data.map(K=>K.id||K.name).filter(Boolean):(b==null?void 0:b.items)||(b==null?void 0:b.models)||[]).catch(()=>[])};Promise.all([A(_,I,(p=r==null?void 0:r.dev)==null?void 0:p.asrModelsEndpoint),A(M,S,(w=r==null?void 0:r.dev)==null?void 0:w.ttsVoicesEndpoint),A(L,q,(E=r==null?void 0:r.dev)==null?void 0:E.voiceModelsEndpoint)]).then(([C,R,O])=>{y.asr=C,y.ttsVoices=R,y.voiceModels=O,t(y)})}}).catch(()=>{})}}function pt(){N=null;const e=document.getElementById("modalTitle");e.textContent="添加新人物",document.getElementById("characterForm").reset(),Te(null),document.getElementById("characterModal").style.display="block"}function ht(e){const t=h.find(n=>n.id===e);t&&(N=e,document.getElementById("modalTitle").textContent="编辑人物",document.getElementById("characterName").value=t.name,document.getElementById("characterDesc").value=t.description,document.getElementById("characterPersonality").value=t.personality,document.getElementById("characterBackground").value=t.background||"",document.getElementById("characterFormat").value=t.responseFormat||"",document.getElementById("characterOpening").value=t.openingMessage||"",Te(t),document.getElementById("characterModal").style.display="block")}function yt(e){if(confirm("确定要删除这个人物吗？"))if(h=h.filter(t=>t.id!==e),delete $[e],v&&v.id===e&&h.length>0?v=h[0]:h.length||(v=null),ee(h),Y(),Z(),Q(),h.length>0&&v)F(v.id),U();else{U();const t=document.getElementById("chatMessages");t&&(t.innerHTML="")}}function Le(){document.getElementById("characterModal").style.display="none"}function Q(){const e=h.length,t=Object.values($).reduce((i,l)=>i+l.filter(c=>c.type==="user").length,0),n=h.reduce((i,l)=>i.conversationCount>l.conversationCount?i:l,h[0]),a=document.getElementById("totalCharacters"),s=document.getElementById("totalConversations"),o=document.getElementById("mostActive");a&&(a.textContent=e),s&&(s.textContent=t),o&&(o.textContent=n?n.name:"无")}function be(){if(!v)return;const e=h.find(t=>t.id===v.id);e&&(e.lastActive="刚刚",e.conversationCount=(e.conversationCount||0)+1,ee(h)),P(),Z(),te(),Q()}function wt(){alert("附件功能开发中...")}function bt(){alert("语音通话功能开发中...")}async function Et(){if(!m.processing){if(m.isRecording){Me(!1);return}x(),!Xe()&&await Qe()}}document.addEventListener("DOMContentLoaded",()=>{me().then(()=>{var l;Fe(),Y(),P(),te(),Z(),v&&F(v.id),U(),Q(),_e({currentTarget:document.querySelector(".settings-menu .menu-item")},"characters"),xe();const e=document.getElementById("historySearch");e==null||e.addEventListener("input",()=>{P()}),(l=document.querySelectorAll(".avatar-mode-btn"))==null||l.forEach(c=>{c.addEventListener("click",()=>{const d=c.getAttribute("data-avatar-mode");d&&ce(d)})});const t=document.getElementById("characterEmoji");t==null||t.addEventListener("input",c=>{f.emoji=c.target.value,V()});const n=document.getElementById("characterAvatarUrl");n==null||n.addEventListener("input",c=>{f.url=c.target.value,V()});const a=document.getElementById("characterAvatarFile");a==null||a.addEventListener("change",Je),document.body.setAttribute("data-theme","light"),localStorage.setItem("theme","light");const s=document.getElementById("currentCharacterAvatar");s==null||s.addEventListener("click",c=>{c.stopPropagation();const d=document.getElementById("roleDropdown");if(d){const u=s.getBoundingClientRect(),g=document.querySelector(".chat-header").getBoundingClientRect();d.style.left=`${u.left-g.left}px`,d.style.top=`${u.bottom-g.top+8}px`}we()});const o=document.getElementById("roleNameButton");o==null||o.addEventListener("click",c=>{c.stopPropagation();const d=document.getElementById("roleDropdown");if(d){const u=o.getBoundingClientRect(),g=document.querySelector(".chat-header").getBoundingClientRect();d.style.left=`${u.left-g.left}px`,d.style.top=`${u.bottom-g.top+8}px`}we()}),document.addEventListener("click",c=>{const d=document.getElementById("roleDropdown");if(!d||d.classList.contains("hidden"))return;const u=document.getElementById("currentCharacterAvatar"),g=document.getElementById("roleNameButton");d.contains(c.target)||u!=null&&u.contains(c.target)||g!=null&&g.contains(c.target)||$e()});const i=document.getElementById("characterForm");i==null||i.addEventListener("submit",c=>{c.preventDefault();const d={name:document.getElementById("characterName").value,description:document.getElementById("characterDesc").value,personality:document.getElementById("characterPersonality").value,background:document.getElementById("characterBackground").value,responseFormat:document.getElementById("characterFormat").value,openingMessage:document.getElementById("characterOpening").value},u=We();if(d.icon=u.icon||d.icon||"🧑",d.avatarType=u.avatarType,d.avatarUrl=u.avatarUrl,N){const g=h.find(p=>p.id===N);if(g){Object.assign(g,d);const p=$[g.id];p&&p.length&&(p[0]=J(g,p[0].timestamp||Date.now()))}}else{const g={id:Date.now(),...d,createdAt:new Date().toISOString().split("T")[0],lastActive:"刚刚",conversationCount:0};h.push(g),$[g.id]=[J(g)],v=g,N=null}ee(h),Y(),P(),Z(),v&&F(v.id),U(),Q(),Le(),N=null})})});window.showSettings=gt;window.showChat=ft;window.showSettingsTab=_e;window.showAddCharacterModal=pt;window.editCharacter=ht;window.deleteCharacter=yt;window.closeCharacterModal=Le;window.sendMessage=Be;window.handleKeyPress=mt;window.attachFile=wt;window.startVoiceCall=bt;window.startVoiceInput=Et;window.setTheme=e=>{document.body.setAttribute("data-theme",e),localStorage.setItem("theme",e)};window.newConversation=()=>{if(!v)return;const e=v.id;B&&B.charId===e&&(B=null);const t=$[e]||[];k[e]=k[e]||[],t&&t.length>0&&k[e].push({id:`${e}-${Date.now()}`,messages:t}),$[e]=[J(v)],B=null,F(e),P()};
