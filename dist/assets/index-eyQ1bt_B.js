(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function n(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(o){if(o.ep)return;o.ep=!0;const s=n(o);fetch(o.href,s)}})();const Le=[{id:1,name:"智慧导师",icon:"🧙",description:"博学多才，善于解答各种问题",personality:"耐心、睿智、温和",background:"来自古老图书馆的智慧守护者，擅长将复杂知识拆解为可执行方案。",responseFormat:"回答包含背景、分析和行动建议三个段落。",avatarType:"pixel",avatarUrl:"",openingMessage:"你好！我是智慧导师，很高兴与你讨论任何问题。请告诉我你想探索的方向。",createdAt:"2024-01-15",lastActive:"刚刚",conversationCount:45},{id:2,name:"创意助手",icon:"🎨",description:"富有想象力，擅长创意和设计",personality:"活泼、创新、艺术感强",background:"常驻创意实验室，熟悉视觉艺术、品牌设计与叙事构建。",responseFormat:"先给一个灵感主题，再给三个可执行创意点子。",avatarType:"pixel",avatarUrl:"",openingMessage:"嗨！我是创意助手，随时准备一起头脑风暴。说说你脑海中的想法吧！",createdAt:"2024-01-10",lastActive:"5分钟前",conversationCount:38},{id:3,name:"商业顾问",icon:"💼",description:"专业商务，擅长策略分析和市场规划",personality:"理性、专业、目标导向",background:"来自国际咨询公司，熟悉市场分析、运营优化与财务模型。",responseFormat:"使用数字编号列出洞察、风险和行动建议。",avatarType:"pixel",avatarUrl:"",openingMessage:"您好，我是商业顾问。欢迎分享您的业务挑战，我们可以先明确目标再逐步分析。",createdAt:"2024-01-05",lastActive:"1小时前",conversationCount:44}],ge="app_characters";function xe(e){return e.map(t=>({...t}))}function ve(e,t){const n=(e==null?void 0:e.avatarType)||(e!=null&&e.avatarUrl?"url":e!=null&&e.icon?"emoji":"pixel"),a=(e==null?void 0:e.avatarUrl)||"",o=typeof(e==null?void 0:e.icon)=="string"?e.icon:"";return{id:(e==null?void 0:e.id)??Date.now()+t,name:(e==null?void 0:e.name)||`角色${t+1}`,icon:o||"🧑",description:(e==null?void 0:e.description)||"",personality:(e==null?void 0:e.personality)||"",background:(e==null?void 0:e.background)||"",responseFormat:(e==null?void 0:e.responseFormat)||"",openingMessage:(e==null?void 0:e.openingMessage)||"",avatarType:n,avatarUrl:a,createdAt:(e==null?void 0:e.createdAt)||new Date().toISOString().split("T")[0],lastActive:(e==null?void 0:e.lastActive)||"刚刚",conversationCount:(e==null?void 0:e.conversationCount)||0}}function Z(e){try{localStorage.setItem(ge,JSON.stringify(e))}catch{}}function Ae(){try{const e=localStorage.getItem(ge);if(!e)return null;const t=JSON.parse(e);return!Array.isArray(t)||!t.length?null:t.map((n,a)=>ve(n,a))}catch{return null}}function Ce(){const e=Ae();if(e)return e;const t=xe(Le).map((n,a)=>ve(n,a));return Z(t),t}let p=Ce(),v=p[0]||null,w={},L={},B=null,O=null;const De="admin_character_prompts";let g={mode:"emoji",emoji:"",url:"",uploadData:"",uploadName:"",baseCharacter:null};function y(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function te(e=""){return y(e).replace(/\"/g,"&quot;").replace(/'/g,"&#39;")}function k(e,t=40){const n=Number.isFinite(t)?Math.max(24,t):40,a=`style="width:${n}px;height:${n}px;"`;if(!e)return`<div class="avatar-chip" ${a}><span class="avatar-emoji" style="font-size:${Math.round(n*.6)}px;">🖼️</span></div>`;const o=e.avatarType,s=e.avatarUrl;if((o==="url"||o==="upload")&&s)return`<div class="avatar-chip" ${a}><img src="${te(s)}" alt="${te(e.name||"avatar")}" /></div>`;if((o==="emoji"||!o&&e.icon)&&e.icon)return`<div class="avatar-chip" ${a}><span class="avatar-emoji" style="font-size:${Math.round(n*.6)}px;">${y(e.icon)}</span></div>`;const i=Ge(e.name||"");return`<div class="avatar-chip avatar-pixel-wrapper" ${a}>${i}</div>`}let ae=!1;function de(e){ae=e;const t=document.getElementById("messageInput"),n=document.querySelector(".send-btn");if(t)if(t.disabled=e,e)t.setAttribute("data-prev-ph",t.getAttribute("placeholder")||""),t.setAttribute("placeholder","正在生成回复…");else{const a=t.getAttribute("data-prev-ph");a!==null&&t.setAttribute("placeholder",a)}n&&(n.disabled=e)}function K(e,t=Date.now()){const n=(e==null?void 0:e.openingMessage)&&e.openingMessage.trim()||`你好！我是${(e==null?void 0:e.name)||"伙伴"}，很高兴与你交流。`;return{type:"ai",author:(e==null?void 0:e.name)||"AI",text:n,time:ne(t),timestamp:t}}function ke(){p.length&&p.forEach((e,t)=>{const a=We(e.lastActive)??Date.now()-t*5*60*1e3;w[e.id]=[K(e,a)],L[e.id]=[]})}function He(e){if(!e)return"";try{const t=localStorage.getItem(De);if(!t)return"";const n=JSON.parse(t);if(n&&typeof n=="object"){const a=n[e]??n[Number(e)]??null;return a?typeof a=="string"?a:(a==null?void 0:a.prompt)||"":""}return""}catch{return""}}function Oe(e){if(!e)return"";const t=[],n=He(e.id);return n&&t.push(n),e.description&&t.push(`角色定位：
${e.description}`),e.personality&&t.push(`性格特征：
${e.personality}`),e.background&&t.push(`背景信息：
${e.background}`),e.responseFormat&&t.push(`回答格式要求：
${e.responseFormat}`),t.join(`

`).trim()}function Ne(e,t){const n=[],a=Oe(t);return a&&n.push({role:"system",content:a}),n.push({role:"user",content:e}),n}function Ve(){const e=document.querySelector(".avatar-upload-hint");if(!e)return;e.dataset.defaultHint||(e.dataset.defaultHint=e.textContent);const t=g.uploadData&&g.uploadName?`已选择：${g.uploadName}`:e.dataset.defaultHint;e.textContent=t;const n=document.querySelector(".avatar-upload-btn span");n&&(n.textContent=g.uploadData?"重新选择图片":"选择图片")}function Ue(){if(g.mode==="emoji"&&g.emoji.trim())return{type:"emoji",value:g.emoji.trim()};if(g.mode==="url"&&g.url.trim())return{type:"image",value:g.url.trim()};if(g.mode==="upload"&&g.uploadData)return{type:"image",value:g.uploadData};const e=g.baseCharacter;if(e){if((e.avatarType==="url"||e.avatarType==="upload")&&e.avatarUrl)return{type:"image",value:e.avatarUrl};if(e.avatarType==="emoji"&&e.icon)return{type:"emoji",value:e.icon}}return{type:"placeholder",value:"🖼️"}}function V(){const e=document.getElementById("avatarPreview");if(!e)return;const t=Ue();t.type==="image"?e.innerHTML=`<div class="avatar-img-wrapper"><img src="${te(t.value)}" alt="头像预览" /></div>`:t.type==="emoji"?e.innerHTML=`<span class="avatar-emoji">${y(t.value)}</span>`:e.innerHTML=`<span class="placeholder">${y(t.value)}</span>`,Ve()}function oe(e,t=!0){g.mode=e,document.querySelectorAll(".avatar-mode-btn").forEach(n=>{n.classList.toggle("active",n.dataset.avatarMode===e)}),document.querySelectorAll(".avatar-input-field").forEach(n=>{const o=n.getAttribute("data-avatar-field")===e;if(n.classList.toggle("hidden",!o),o&&t){const s=n.querySelector('input:not([type="file"])');s==null||s.focus()}}),V()}function Pe(e){var a,o;const t=(o=(a=e.target)==null?void 0:a.files)==null?void 0:o[0];if(!t){g.uploadData="",g.uploadName="",V();return}const n=new FileReader;n.onload=s=>{var i;g.uploadData=((i=s.target)==null?void 0:i.result)||"",g.uploadName=t.name||"",oe("upload",!1),V()},n.readAsDataURL(t)}function pe(e){g={mode:"emoji",emoji:"",url:"",uploadData:"",uploadName:"",baseCharacter:e||null},e&&(e.avatarType==="url"?(g.mode="url",g.url=e.avatarUrl||""):e.avatarType==="upload"?(g.mode="upload",g.uploadData=e.avatarUrl||"",g.uploadName=e.avatarUrl?"已保存图片":""):e.avatarType==="emoji"?(g.mode="emoji",g.emoji=e.icon||""):e.icon&&(g.mode="emoji",g.emoji=e.icon));const t=document.getElementById("characterEmoji");t&&(t.value=g.emoji||"");const n=document.getElementById("characterAvatarUrl");n&&(n.value=g.url||"");const a=document.getElementById("characterAvatarFile");a&&(a.value=""),oe(g.mode,!1),V()}function Re(){var a,o;const e=(a=g.emoji)==null?void 0:a.trim(),t=(o=g.url)==null?void 0:o.trim();if(g.mode==="emoji"&&e)return{avatarType:"emoji",avatarUrl:"",icon:e};if(g.mode==="url"&&t)return{avatarType:"url",avatarUrl:t,icon:""};if(g.mode==="upload"&&g.uploadData)return{avatarType:"upload",avatarUrl:g.uploadData,icon:""};const n=g.baseCharacter;return n?{avatarType:n.avatarType||"emoji",avatarUrl:n.avatarUrl||"",icon:n.icon||""}:{avatarType:"emoji",avatarUrl:"",icon:e||"🙂"}}function Fe(e){if(!e)return null;const t=e.split(/\n+/).map(s=>s.trim()).filter(Boolean);if(t.length<4)return null;const n=/^([A-Za-z\u4e00-\u9fa5]{1,16})(?:[:：])?$/,a=[];let o=null;return t.forEach(s=>{n.test(s)&&s.length<=10?(o&&a.push(o),o={title:s.replace(/[:：]$/,""),body:[]}):(o||(o={title:"思考",body:[]}),o.body.push(s))}),o&&a.push(o),a.length<2?null:a}function qe(e){const t=Fe(e);if(!t)return null;const n={背景:"🗺️",角色:"🧍",思考:"🧠",分析:"🔍",计划:"🗒️",策略:"🧭",行动建议:"✅",建议:"✅",结果:"📌",总结:"📘"},a=["🧠","🔍","✅","💡","🗺️"];let o=0;return`<div class="reasoning-bubble">${t.map(i=>{const l=n[i.title]||a[o++%a.length],c=i.body.join(`
`),d=we(c);return`
        <div class="reasoning-section">
          <div class="reasoning-title"><span class="reasoning-icon">${l}</span><span>${y(i.title)}</span></div>
          <div class="reasoning-body">${d}</div>
        </div>
      `}).join("")}</div>`}function ze(){return`
  <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
    <rect x="6" y="1" width="4" height="2" fill="#5d4037"/>
    <rect x="5" y="3" width="6" height="2" fill="#5d4037"/>
    <rect x="4" y="5" width="8" height="1" fill="#5d4037"/>
    <rect x="3" y="6" width="10" height="1" fill="#5d4037"/>
    <rect x="6" y="7" width="4" height="3" fill="#f3c26b"/>
    <rect x="5" y="10" width="6" height="4" fill="#6a1b9a"/>
    <rect x="11" y="9" width="1" height="5" fill="#2e7d32"/>
    <rect x="12" y="9" width="1" height="1" fill="#a5d6a7"/>
  </svg>`}function je(){return`
  <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
    <rect x="6" y="6" width="4" height="3" fill="#f3c26b"/>
    <rect x="5" y="9" width="6" height="5" fill="#8e44ad"/>
    <rect x="9" y="4" width="3" height="2" fill="#7f8c8d"/>
    <rect x="3" y="10" width="3" height="2" fill="#c49b6e"/>
    <rect x="3" y="10" width="1" height="1" fill="#e74c3c"/>
    <rect x="4" y="11" width="1" height="1" fill="#3498db"/>
    <rect x="5" y="10" width="1" height="1" fill="#f1c40f"/>
  </svg>`}function Ke(){return`
  <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
    <rect x="6" y="6" width="4" height="3" fill="#f3c26b"/>
    <rect x="5" y="9" width="6" height="5" fill="#34495e"/>
    <rect x="7" y="11" width="2" height="2" fill="#ecf0f1"/>
    <rect x="6" y="4" width="4" height="2" fill="#7f8c8d"/>
  </svg>`}function fe(){return`
  <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
    <rect x="6" y="6" width="4" height="3" fill="#f3c26b"/>
    <rect x="5" y="9" width="6" height="5" fill="#6d4c41"/>
  </svg>`}function Ge(e){return e==="智慧导师"?ze():e==="创意助手"?je():e==="商业顾问"?Ke():fe()}function ne(e){return new Date(e).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})}function Je(e){const t=Date.now()-e,n=60*1e3,a=60*n,o=24*a;return t<n?"刚刚":t<a?`${Math.floor(t/n)}分钟前`:t<o?`${Math.floor(t/a)}小时前`:new Date(e).toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})}function We(e){if(!e)return;if(e.includes("刚刚"))return Date.now();const t=e.match(/(\d+)分钟/);if(t)return Date.now()-parseInt(t[1],10)*60*1e3;const n=e.match(/(\d+)小时/);if(n)return Date.now()-parseInt(n[1],10)*60*60*1e3}function N(){var a;const e=document.getElementById("historyList");if(!e)return;e.innerHTML="";const t=(((a=document.getElementById("historySearch"))==null?void 0:a.value)||"").trim().toLowerCase(),n=[];p.forEach(o=>{const s=w[o.id]||[];if(s.length){const i=s[s.length-1];n.push({type:"current",char:o,sessionId:"current",lastMsg:i,lastTs:i.timestamp})}(L[o.id]||[]).forEach(i=>{const l=i.messages[i.messages.length-1];n.push({type:"archived",char:o,sessionId:i.id,lastMsg:l,lastTs:(l==null?void 0:l.timestamp)||0})})}),n.sort((o,s)=>s.lastTs-o.lastTs),n.forEach(o=>{const{char:s,type:i,sessionId:l,lastMsg:c,lastTs:d}=o,u=d?Je(d):"",m=c?c.text:i==="archived"?"历史会话":"暂无对话";if(t&&!(s.name.toLowerCase().includes(t)||m.toLowerCase().includes(t)))return;const f=document.createElement("div");f.className="history-item",f.onclick=()=>{i==="archived"?Ye(s.id,l):(B=null,se(s.id))},f.innerHTML=`
      <div class="history-main">
        <div class="history-title">
          <span class="history-name">${m}</span>
          <span class="history-time">${u}</span>
        </div>
      </div>
      <button class="history-del-btn" title="删除" aria-label="删除">
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
          <path d="M10 11v6"></path>
          <path d="M14 11v6"></path>
          <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>
        </svg>
      </button>
    `;const E=f.querySelector(".history-del-btn");E.onclick=I=>{I.stopPropagation(),Ze(s.id,i,l)},e.appendChild(f)})}function Ye(e,t){const n=document.getElementById("chatMessages");if(!n)return;n.innerHTML="";const a=(L[e]||[]).find(o=>o.id===t);a&&(B={charId:e,sessionId:t},a.messages.forEach(o=>W(o)))}function Ze(e,t,n){if(window.confirm("确定删除该对话吗？删除后无法恢复")){if(t==="archived"){if(L[e]=(L[e]||[]).filter(o=>o.id!==n),B&&B.charId===e&&B.sessionId===n){B=null;const o=document.getElementById("chatMessages");o&&(o.innerHTML="")}}else if(w[e]=[],!B&&v&&v.id===e){const o=document.getElementById("chatMessages");o&&(o.innerHTML="")}N()}}function X(){const e=document.getElementById("roleDropdown");if(!e)return;e.innerHTML="";const t=v==null?void 0:v.id;p.forEach(n=>{const a=document.createElement("div");a.className=`model-item ${t&&n.id===t?"active":""}`;const o=k(n,36);a.innerHTML=`
      <div class="avatar">${o}</div>
      <div class="name">${y(n.name)}</div>
    `,a.onclick=()=>{se(n.id),he();const s=document.getElementById("roleSwitcherLabel");s&&(s.textContent=v.name);const i=document.getElementById("currentCharacterAvatar");i&&(i.classList.remove("pulse"),i.offsetWidth,i.classList.add("pulse"))},e.appendChild(a)})}function ue(){const e=document.getElementById("roleDropdown");e&&(e.classList.contains("hidden")?(X(),e.classList.remove("hidden"),e.classList.add("show")):(e.classList.remove("show"),e.classList.add("hidden")))}function he(){const e=document.getElementById("roleDropdown");e==null||e.classList.add("hidden")}function G(){const e=document.getElementById("characterList");e&&(e.innerHTML="",p.forEach(t=>{const n=document.createElement("div"),a=v&&t.id===v.id;n.className=`character-item ${a?"active":""}`,n.onclick=()=>se(t.id);const o=k(t);n.innerHTML=`
      <div class="character-header">
        <div class="character-avatar">${o}</div>
        <div class="character-name">${y(t.name)}</div>
      </div>
      <div class="character-desc">${y(t.description)}</div>
      <div style="font-size: 10px; color: #8b4513; margin-top: 5px;">
        最后对话：${y(t.lastActive)}
      </div>
    `,e.appendChild(n)}))}function J(){const e=document.getElementById("characterManagement");e&&(e.innerHTML="",p.forEach(t=>{const n=document.createElement("div");n.className="character-card";const a=k(t,60);n.innerHTML=`
      <div class="character-avatar" style="width: 60px; height: 60px;">${a}</div>
      <div class="character-card-info">
        <h3>${y(t.name)}</h3>
        <p>描述：${y(t.description)}</p>
        <p>性格：${y(t.personality)}</p>
        ${t.background?`<p>背景：${y(t.background)}</p>`:""}
        ${t.responseFormat?`<p>回答格式：${y(t.responseFormat)}</p>`:""}
        <div class="meta">创建时间：${y(t.createdAt)}</div>
      </div>
      <div class="character-actions">
        <button class="btn btn-small btn-edit" onclick="editCharacter(${t.id})">编辑</button>
        <button class="btn btn-small btn-delete" onclick="deleteCharacter(${t.id})">删除</button>
      </div>
    `,e.appendChild(n)}))}function U(){const e=document.getElementById("currentCharacterAvatar"),t=document.getElementById("currentCharacterName");if(!v){e&&(e.innerHTML=k(null,48)),t&&(t.textContent="");return}e&&(e.innerHTML=k(v,48)),t&&(t.textContent=v.name)}function se(e){const t=p.find(n=>n.id===e);t&&(v=t,G(),X(),P(e),U())}function P(e){const t=document.getElementById("chatMessages");if(!t)return;t.innerHTML="",(w[e]||[]).forEach(a=>{W(a)}),t.scrollTop=t.scrollHeight}function W(e){const t=document.getElementById("chatMessages");if(!t)return;const n=document.createElement("div");n.className=`message ${e.type}`;const a=e.type==="ai"?k(v,36):`<div class="avatar-chip" style="width:36px;height:36px;">${fe()}</div>`,o=t.lastElementChild;if(o&&o.classList.contains(e.type)&&n.classList.add("grouped"),e.type==="ai"){n.innerHTML=`
      <div class="message-avatar">${a}</div>
      <div class="message-content"><div class="message-text"></div></div>
      <div class="message-time outside">${e.time}</div>
    `;try{const i=n.querySelector(".message-text");if(i){const l=qe(e.text);l?(n.classList.add("ai-reasoning"),i.innerHTML=l):i.innerHTML=we(e.text)}}catch{n.querySelector(".message-text").textContent=e.text}}else{n.innerHTML=`
      <div class="message-time outside">${e.time}</div>
      <div class="message-content"><div class="message-text"></div></div>
      <div class="message-avatar">${a}</div>
    `;const i=n.querySelector(".message-text");i.textContent=e.text}t.appendChild(n)}function ye(){if(!v||ae)return;const e=document.getElementById("messageInput");if(!e)return;const t=e.value.trim();if(!t)return;const n=Date.now(),a={type:"user",text:t,time:ne(n),timestamp:n};B=null,w[v.id]=w[v.id]||[],w[v.id].push(a),W(a),e.value="",me(),de(!0);const o=document.getElementById("chatMessages"),s=document.createElement("div");s.className="message ai typing",s.innerHTML=`
    <div class="message-avatar">${k(v,36)}</div>
    <div class="message-content"><div class="typing-dots"><span></span><span></span><span></span></div></div>
  `,o.appendChild(s),setTimeout(()=>{const i=c=>{const d=Date.now(),u={type:"ai",author:v.name,text:c,time:ne(d),timestamp:d};s.remove(),w[v.id].push(u),W(u);const m=document.getElementById("chatMessages");m&&(m.scrollTop=m.scrollHeight),me(),de(!1)},l=Ne(t,v);localStorage.getItem("dev_enabled")==="true"?Ie().then(()=>{r.dev=r.dev||{},r.dev.enabled=!0,r.dev.llmBase=localStorage.getItem("dev_llm_base")||r.dev.llmBase,localStorage.getItem("dev_api_key");let c="";Qe(l,d=>{c+=d;const u=s.querySelector(".message-content");u&&(u.innerHTML=c);const m=document.getElementById("chatMessages");m&&(m.scrollTop=m.scrollHeight)},()=>{i(c||"")},d=>{const u=typeof d=="string"?d:(d==null?void 0:d.message)||"未知错误";i(`调用失败：${u}`)})}):i(Xe(t,v))},1e3)}function Xe(e,t){const a={智慧导师:["这是一个很有趣的问题，让我来为你详细解答。","从我的经验来看，这个问题有几个关键点需要考虑。","你提出了一个很好的观点，我建议你可以从以下几个方面深入思考。"],创意助手:["哇！这个想法太有创意了！我有一些更有趣的建议给你。","让我发挥一下想象力，我觉得可以这样设计...","这个概念很棒！我们可以加入更多创新的元素。"],商业顾问:["从商业角度分析，这个方案有几个优势和需要注意的风险。","根据市场调研数据，我建议采用以下策略来优化这个项目。","这个投资机会看起来很有潜力，但我们需要仔细评估ROI。"]}[t.name]||["这是一个很好的问题，让我为你分析一下。"];return a[Math.floor(Math.random()*a.length)]}function we(e){if(!e)return"";let t=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");const n=[];return t=t.replace(/```([a-zA-Z0-9_-]+)?\n([\s\S]*?)```/g,(a,o,s)=>{const i=`__CODE_${n.length}__`;return n.push(`<pre><code class="lang-${o||"plain"}">${s}</code></pre>`),i}),t=t.replace(/^######\s+(.+)$/gm,"<h6>$1</h6>").replace(/^#####\s+(.+)$/gm,"<h5>$1</h5>").replace(/^####\s+(.+)$/gm,"<h4>$1</h4>").replace(/^###\s+(.+)$/gm,"<h3>$1</h3>").replace(/^##\s+(.+)$/gm,"<h2>$1</h2>").replace(/^#\s+(.+)$/gm,"<h1>$1</h1>"),t=t.replace(/^>\s+(.+)$/gm,"<blockquote>$1</blockquote>"),t=t.replace(/^(?:\-|\*)\s+(.+)$/gm,"<li>$1</li>"),t=t.replace(/(?:<li>.*<\/li>\n?)+/gs,a=>`<ul>${a}</ul>`),t=t.replace(/^(\d+)\.\s+(.+)$/gm,"<li>$2</li>"),t=t.replace(/(?:<li>.*<\/li>\n?)+/gs,a=>a.startsWith("<ul>")?a:`<ol>${a}</ol>`),t=t.replace(/\[([^\]]+)\]\((https?:[^)\s]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'),t=t.replace(/`([^`]+)`/g,"<code>$1</code>"),t=t.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),t=t.replace(new RegExp("(?<!\\*)\\*(?!\\*)(.+?)(?<!\\*)\\*(?!\\*)","g"),"<em>$1</em>"),t=t.replace(/^(-{3,}|\*{3,})$/gm,"<hr/>"),t=t.replace(/(^|\n)(?!<(h\d|ul|ol|li|pre|blockquote|hr|p|code))([^\n]+)(?=\n|$)/g,(a,o,s,i)=>`${o}<p>${i}</p>`),n.forEach((a,o)=>{t=t.replace(`__CODE_${o}__`,a)}),t}async function Qe(e,t,n,a){var m,f,E,I,b,x,M,T,$,S,R;const o=new AbortController,s=2e4,i=12e4;let l=null,c=null;const d=()=>{l&&clearTimeout(l),l=setTimeout(()=>{o.abort("idle-timeout")},s)},u=()=>{l&&clearTimeout(l),c&&clearTimeout(c),l=null,c=null};try{const _=localStorage.getItem("dev_llm_base")||((m=r==null?void 0:r.dev)==null?void 0:m.llmBase),A=localStorage.getItem("dev_api_key")||"",C=localStorage.getItem("cfg_llm_model")||((E=(f=r.defaults)==null?void 0:f.llm)==null?void 0:E[0])||"",H=Array.isArray(e)&&e.length?e:[{role:"user",content:typeof e=="string"?e:""}];if(!_||!A||!C)throw new Error("缺少 base/key/model");const F=((I=r==null?void 0:r.dev)==null?void 0:I.authHeader)||"Authorization",q=((b=r==null?void 0:r.dev)==null?void 0:b.authScheme)||"Bearer";c=setTimeout(()=>o.abort("hard-timeout"),i),d();const h=await fetch(`${_}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"text/event-stream",[F]:`${q} ${A}`},body:JSON.stringify({model:C,stream:!0,messages:H}),signal:o.signal});if(!h.ok){const ee=await h.text();throw new Error(ee||`HTTP ${h.status}`)}const z=h.body.getReader(),Te=new TextDecoder;let Q="";for(;;){const{value:ee,done:$e}=await z.read();if($e)break;d(),Q+=Te.decode(ee,{stream:!0});const ie=Q.split(/\r?\n\r?\n/);Q=ie.pop();for(const Be of ie){const Se=Be.split(/\r?\n/).filter(Boolean);for(const _e of Se){const re=_e.replace(/\r$/,"").match(/^data:\s*(.*)$/);if(!re)continue;const le=(re[1]||"").trim();if(le==="[DONE]"){u(),n&&n();return}try{const D=JSON.parse(le),ce=((T=(M=(x=D==null?void 0:D.choices)==null?void 0:x[0])==null?void 0:M.delta)==null?void 0:T.content)||((R=(S=($=D==null?void 0:D.choices)==null?void 0:$[0])==null?void 0:S.message)==null?void 0:R.content)||"";ce&&t&&t(ce)}catch{}}}}u(),n&&n()}catch(_){u(),a&&a(_)}}function et(e){e.key==="Enter"&&(e.preventDefault(),ae||ye())}function tt(){const e=document.getElementById("chatInterface"),t=document.getElementById("settingsInterface");e==null||e.classList.remove("active"),t==null||t.classList.add("active")}function nt(){const e=document.getElementById("chatInterface"),t=document.getElementById("settingsInterface");t==null||t.classList.remove("active"),e==null||e.classList.add("active")}function Ee(e,t){var a;document.querySelectorAll(".menu-item").forEach(o=>o.classList.remove("active")),e.currentTarget.classList.add("active");const n={characters:document.getElementById("panel-characters"),models:document.getElementById("panel-models")};Object.values(n).forEach(o=>o==null?void 0:o.classList.add("hidden")),(a=n[t])==null||a.classList.remove("hidden")}let r=null;function Ie(){return r?Promise.resolve(r):fetch("/app-config.json",{cache:"no-store"}).then(e=>e.json()).then(e=>r=e).catch(()=>r={defaults:{}})}function j(e,t){var o,s,i,l;const a={VITE_LLM_MODELS:(o=r==null?void 0:r.defaults)==null?void 0:o.llm,VITE_ASR_MODELS:(s=r==null?void 0:r.defaults)==null?void 0:s.asr,VITE_TTS_VOICES:(i=r==null?void 0:r.defaults)==null?void 0:i.ttsVoices,VITE_VOICE_MODELS:(l=r==null?void 0:r.defaults)==null?void 0:l.voiceModels}[e];return Array.isArray(a)&&a.length?a:t}function at(){const e=j("VITE_LLM_MODELS",["gpt-4o-mini","claude-3.5-haiku","qwen2.5-14b"]),t=j("VITE_ASR_MODELS",["deepgram:nova-2","whisper:large-v3","azure:speech"]),n=j("VITE_TTS_VOICES",["openai:alloy","elevenlabs:Rachel","azure:zh-CN-XiaoxiaoNeural"]),a=j("VITE_VOICE_MODELS",["openai:gpt-4o-realtime","deepgram:aura"]),o=(d,u)=>{try{const m=localStorage.getItem(d);return m?JSON.parse(m):u}catch{return u}},s=o("visible_llm_models",e).filter(Boolean),i=o("visible_asr_models",t).filter(Boolean),l=o("visible_tts_voices",n).filter(Boolean),c=o("visible_voice_models",a).filter(Boolean);return{llm:s,asr:i,ttsVoices:l,voiceModels:c}}function be(){var a,o,s,i;const e=document.getElementById("panel-models");if(!e)return;const t=l=>{var b,x;const{llm:c,asr:d,ttsVoices:u,voiceModels:m}=l,f=(M,T)=>localStorage.getItem(M)||T,E={llm:f("cfg_llm_model",c[0]||""),asr:f("cfg_asr_model",d[0]||""),tts:f("cfg_tts_voice",u[0]||""),vrm:f("cfg_voice_model",m[0]||"")},I=(M,T)=>M.map($=>`<option value="${$}" ${$===T?"selected":""}>${$}</option>`).join("");e.innerHTML=`
      <div class="form-section">
        <div class="form-row">
          <label>文本 LLM</label>
          <select id="sel-llm" class="select">${I(c,E.llm)}</select>
        </div>
        <div class="form-row">
          <label>ASR（语音识别）</label>
          <select id="sel-asr" class="select">${I(d,E.asr)}</select>
        </div>
        <div class="form-row">
          <label>TTS 声音</label>
          <select id="sel-tts" class="select">${I(u,E.tts)}</select>
        </div>
        <div class="form-row">
          <label>语音大模型</label>
          <select id="sel-vrm" class="select">${I(m,E.vrm)}</select>
        </div>
        <div class="form-actions">
          <button id="btn-save-models" class="btn">保存</button>
          <button id="btn-reset-models" class="btn btn-secondary">恢复默认</button>
        </div>
      </div>
    `,(b=document.getElementById("btn-save-models"))==null||b.addEventListener("click",()=>{const M=document.getElementById("sel-llm"),T=document.getElementById("sel-asr"),$=document.getElementById("sel-tts"),S=document.getElementById("sel-vrm");localStorage.setItem("cfg_llm_model",(M==null?void 0:M.value)||""),localStorage.setItem("cfg_asr_model",(T==null?void 0:T.value)||""),localStorage.setItem("cfg_tts_voice",($==null?void 0:$.value)||""),localStorage.setItem("cfg_voice_model",(S==null?void 0:S.value)||""),alert("已保存模型与声音选择")}),(x=document.getElementById("btn-reset-models"))==null||x.addEventListener("click",()=>{localStorage.removeItem("cfg_llm_model"),localStorage.removeItem("cfg_asr_model"),localStorage.removeItem("cfg_tts_voice"),localStorage.removeItem("cfg_voice_model"),be()})};t(at());const n=(r==null?void 0:r.visibleModelsUrl)||"";if(n&&fetch(n).then(l=>l.json()).then(l=>{const c={llm:l.llm||l.llms||[],asr:l.asr||l.asrs||[],ttsVoices:l.ttsVoices||l.tts||[],voiceModels:l.voiceModels||l.vrm||[]};(c.llm.length||c.asr.length||c.ttsVoices.length||c.voiceModels.length)&&t(c)}).catch(()=>{}),localStorage.getItem("dev_enabled")==="true"){const l=localStorage.getItem("dev_llm_base")||((a=r==null?void 0:r.dev)==null?void 0:a.llmBase),c=localStorage.getItem("dev_api_key"),d=((o=r==null?void 0:r.dev)==null?void 0:o.modelsEndpoint)||"/models";l&&c&&fetch(`${l}${d}`,{headers:{[((s=r==null?void 0:r.dev)==null?void 0:s.authHeader)||"Authorization"]:`${((i=r==null?void 0:r.dev)==null?void 0:i.authScheme)||"Bearer"} ${c}`}}).then(u=>u.json()).then(u=>{var f,E,I;const m=Array.isArray(u==null?void 0:u.data)?u.data.map(b=>b.id).filter(Boolean):(u==null?void 0:u.models)||[];if(m.length){const b={llm:m,asr:[],ttsVoices:[],voiceModels:[]},x=localStorage.getItem("dev_asr_base")||l,M=localStorage.getItem("dev_asr_key")||c,T=localStorage.getItem("dev_tts_base")||l,$=localStorage.getItem("dev_tts_key")||c,S=localStorage.getItem("dev_vrm_base")||l,R=localStorage.getItem("dev_vrm_key")||c,_=(A,C,H)=>{var F,q;return!H||!A||!C?Promise.resolve([]):fetch(`${A}${H}`,{headers:{[((F=r==null?void 0:r.dev)==null?void 0:F.authHeader)||"Authorization"]:`${((q=r==null?void 0:r.dev)==null?void 0:q.authScheme)||"Bearer"} ${C}`}}).then(h=>h.json()).then(h=>Array.isArray(h==null?void 0:h.data)?h.data.map(z=>z.id||z.name).filter(Boolean):(h==null?void 0:h.items)||(h==null?void 0:h.models)||[]).catch(()=>[])};Promise.all([_(x,M,(f=r==null?void 0:r.dev)==null?void 0:f.asrModelsEndpoint),_(T,$,(E=r==null?void 0:r.dev)==null?void 0:E.ttsVoicesEndpoint),_(S,R,(I=r==null?void 0:r.dev)==null?void 0:I.voiceModelsEndpoint)]).then(([A,C,H])=>{b.asr=A,b.ttsVoices=C,b.voiceModels=H,t(b)})}}).catch(()=>{})}}function ot(){O=null;const e=document.getElementById("modalTitle");e.textContent="添加新人物",document.getElementById("characterForm").reset(),pe(null),document.getElementById("characterModal").style.display="block"}function st(e){const t=p.find(n=>n.id===e);t&&(O=e,document.getElementById("modalTitle").textContent="编辑人物",document.getElementById("characterName").value=t.name,document.getElementById("characterDesc").value=t.description,document.getElementById("characterPersonality").value=t.personality,document.getElementById("characterBackground").value=t.background||"",document.getElementById("characterFormat").value=t.responseFormat||"",document.getElementById("characterOpening").value=t.openingMessage||"",pe(t),document.getElementById("characterModal").style.display="block")}function it(e){if(confirm("确定要删除这个人物吗？"))if(p=p.filter(t=>t.id!==e),delete w[e],v&&v.id===e&&p.length>0?v=p[0]:p.length||(v=null),Z(p),G(),J(),Y(),p.length>0&&v)P(v.id),U();else{U();const t=document.getElementById("chatMessages");t&&(t.innerHTML="")}}function Me(){document.getElementById("characterModal").style.display="none"}function Y(){const e=p.length,t=Object.values(w).reduce((i,l)=>i+l.filter(c=>c.type==="user").length,0),n=p.reduce((i,l)=>i.conversationCount>l.conversationCount?i:l,p[0]),a=document.getElementById("totalCharacters"),o=document.getElementById("totalConversations"),s=document.getElementById("mostActive");a&&(a.textContent=e),o&&(o.textContent=t),s&&(s.textContent=n?n.name:"无")}function me(){if(!v)return;const e=p.find(t=>t.id===v.id);e&&(e.lastActive="刚刚",e.conversationCount=(e.conversationCount||0)+1,Z(p)),N(),J(),X(),Y()}function rt(){alert("附件功能开发中...")}function lt(){alert("语音通话功能开发中...")}function ct(){alert("语音输入功能开发中...")}document.addEventListener("DOMContentLoaded",()=>{Ie().then(()=>{var l;ke(),G(),N(),X(),J(),v&&P(v.id),U(),Y(),Ee({currentTarget:document.querySelector(".settings-menu .menu-item")},"characters"),be();const e=document.getElementById("historySearch");e==null||e.addEventListener("input",()=>{N()}),(l=document.querySelectorAll(".avatar-mode-btn"))==null||l.forEach(c=>{c.addEventListener("click",()=>{const d=c.getAttribute("data-avatar-mode");d&&oe(d)})});const t=document.getElementById("characterEmoji");t==null||t.addEventListener("input",c=>{g.emoji=c.target.value,V()});const n=document.getElementById("characterAvatarUrl");n==null||n.addEventListener("input",c=>{g.url=c.target.value,V()});const a=document.getElementById("characterAvatarFile");a==null||a.addEventListener("change",Pe),document.body.setAttribute("data-theme","light"),localStorage.setItem("theme","light");const o=document.getElementById("currentCharacterAvatar");o==null||o.addEventListener("click",c=>{c.stopPropagation();const d=document.getElementById("roleDropdown");if(d){const u=o.getBoundingClientRect(),m=document.querySelector(".chat-header").getBoundingClientRect();d.style.left=`${u.left-m.left}px`,d.style.top=`${u.bottom-m.top+8}px`}ue()});const s=document.getElementById("roleNameButton");s==null||s.addEventListener("click",c=>{c.stopPropagation();const d=document.getElementById("roleDropdown");if(d){const u=s.getBoundingClientRect(),m=document.querySelector(".chat-header").getBoundingClientRect();d.style.left=`${u.left-m.left}px`,d.style.top=`${u.bottom-m.top+8}px`}ue()}),document.addEventListener("click",c=>{const d=document.getElementById("roleDropdown");if(!d||d.classList.contains("hidden"))return;const u=document.getElementById("currentCharacterAvatar"),m=document.getElementById("roleNameButton");d.contains(c.target)||u!=null&&u.contains(c.target)||m!=null&&m.contains(c.target)||he()});const i=document.getElementById("characterForm");i==null||i.addEventListener("submit",c=>{c.preventDefault();const d={name:document.getElementById("characterName").value,description:document.getElementById("characterDesc").value,personality:document.getElementById("characterPersonality").value,background:document.getElementById("characterBackground").value,responseFormat:document.getElementById("characterFormat").value,openingMessage:document.getElementById("characterOpening").value},u=Re();if(d.icon=u.icon||d.icon||"🧑",d.avatarType=u.avatarType,d.avatarUrl=u.avatarUrl,O){const m=p.find(f=>f.id===O);if(m){Object.assign(m,d);const f=w[m.id];f&&f.length&&(f[0]=K(m,f[0].timestamp||Date.now()))}}else{const m={id:Date.now(),...d,createdAt:new Date().toISOString().split("T")[0],lastActive:"刚刚",conversationCount:0};p.push(m),w[m.id]=[K(m)],v=m,O=null}Z(p),G(),N(),J(),v&&P(v.id),U(),Y(),Me(),O=null})})});window.showSettings=tt;window.showChat=nt;window.showSettingsTab=Ee;window.showAddCharacterModal=ot;window.editCharacter=st;window.deleteCharacter=it;window.closeCharacterModal=Me;window.sendMessage=ye;window.handleKeyPress=et;window.attachFile=rt;window.startVoiceCall=lt;window.startVoiceInput=ct;window.setTheme=e=>{document.body.setAttribute("data-theme",e),localStorage.setItem("theme",e)};window.newConversation=()=>{if(!v)return;const e=v.id;B&&B.charId===e&&(B=null);const t=w[e]||[];L[e]=L[e]||[],t&&t.length>0&&L[e].push({id:`${e}-${Date.now()}`,messages:t}),w[e]=[K(v)],B=null,P(e),N()};
