(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();const Ee=[{id:1,name:"æ™ºæ…§å¯¼å¸ˆ",icon:"ğŸ§™",description:"åšå­¦å¤šæ‰ï¼Œå–„äºè§£ç­”å„ç§é—®é¢˜",personality:"è€å¿ƒã€ç¿æ™ºã€æ¸©å’Œ",background:"æ¥è‡ªå¤è€å›¾ä¹¦é¦†çš„æ™ºæ…§å®ˆæŠ¤è€…ï¼Œæ“…é•¿å°†å¤æ‚çŸ¥è¯†æ‹†è§£ä¸ºå¯æ‰§è¡Œæ–¹æ¡ˆã€‚",responseFormat:"å›ç­”åŒ…å«èƒŒæ™¯ã€åˆ†æå’Œè¡ŒåŠ¨å»ºè®®ä¸‰ä¸ªæ®µè½ã€‚",createdAt:"2024-01-15",lastActive:"åˆšåˆš",conversationCount:45},{id:2,name:"åˆ›æ„åŠ©æ‰‹",icon:"ğŸ¨",description:"å¯Œæœ‰æƒ³è±¡åŠ›ï¼Œæ“…é•¿åˆ›æ„å’Œè®¾è®¡",personality:"æ´»æ³¼ã€åˆ›æ–°ã€è‰ºæœ¯æ„Ÿå¼º",background:"å¸¸é©»åˆ›æ„å®éªŒå®¤ï¼Œç†Ÿæ‚‰è§†è§‰è‰ºæœ¯ã€å“ç‰Œè®¾è®¡ä¸å™äº‹æ„å»ºã€‚",responseFormat:"å…ˆç»™ä¸€ä¸ªçµæ„Ÿä¸»é¢˜ï¼Œå†ç»™ä¸‰ä¸ªå¯æ‰§è¡Œåˆ›æ„ç‚¹å­ã€‚",createdAt:"2024-01-10",lastActive:"5åˆ†é’Ÿå‰",conversationCount:38},{id:3,name:"å•†ä¸šé¡¾é—®",icon:"ğŸ’¼",description:"ä¸“ä¸šå•†åŠ¡ï¼Œæ“…é•¿ç­–ç•¥åˆ†æå’Œå¸‚åœºè§„åˆ’",personality:"ç†æ€§ã€ä¸“ä¸šã€ç›®æ ‡å¯¼å‘",background:"æ¥è‡ªå›½é™…å’¨è¯¢å…¬å¸ï¼Œç†Ÿæ‚‰å¸‚åœºåˆ†æã€è¿è¥ä¼˜åŒ–ä¸è´¢åŠ¡æ¨¡å‹ã€‚",responseFormat:"ä½¿ç”¨æ•°å­—ç¼–å·åˆ—å‡ºæ´å¯Ÿã€é£é™©å’Œè¡ŒåŠ¨å»ºè®®ã€‚",createdAt:"2024-01-05",lastActive:"1å°æ—¶å‰",conversationCount:44}],ae="app_characters";function Ie(e){return e.map(t=>({...t}))}function ie(e,t){return{id:(e==null?void 0:e.id)??Date.now()+t,name:(e==null?void 0:e.name)||`è§’è‰²${t+1}`,icon:(e==null?void 0:e.icon)||"ğŸ§‘",description:(e==null?void 0:e.description)||"",personality:(e==null?void 0:e.personality)||"",background:(e==null?void 0:e.background)||"",responseFormat:(e==null?void 0:e.responseFormat)||"",createdAt:(e==null?void 0:e.createdAt)||new Date().toISOString().split("T")[0],lastActive:(e==null?void 0:e.lastActive)||"åˆšåˆš",conversationCount:(e==null?void 0:e.conversationCount)||0}}function J(e){try{localStorage.setItem(ae,JSON.stringify(e))}catch{}}function be(){try{const e=localStorage.getItem(ae);if(!e)return null;const t=JSON.parse(e);return!Array.isArray(t)||!t.length?null:t.map((n,o)=>ie(n,o))}catch{return null}}function Be(){const e=be();if(e)return e;const t=Ie(Ee).map((n,o)=>ie(n,o));return J(t),t}let u=Be(),l=u[0]||null,p={},S={},_=null,D=null;const _e="admin_character_prompts";let Z=!1;function se(e){Z=e;const t=document.getElementById("messageInput"),n=document.querySelector(".send-btn");if(t)if(t.disabled=e,e)t.setAttribute("data-prev-ph",t.getAttribute("placeholder")||""),t.setAttribute("placeholder","æ­£åœ¨ç”Ÿæˆå›å¤â€¦");else{const o=t.getAttribute("data-prev-ph");o!==null&&t.setAttribute("placeholder",o)}n&&(n.disabled=e)}function $e(){u.length&&u.forEach((e,t)=>{const o=ke(e.lastActive)??Date.now()-t*5*60*1e3;p[e.id]=[{type:"ai",author:e.name,text:`ä½ å¥½ï¼æˆ‘æ˜¯${e.name}ï¼Œå¾ˆé«˜å…´ä¸ä½ äº¤æµã€‚`,time:X(o),timestamp:o}],S[e.id]=[]})}function Me(e){if(!e)return"";try{const t=localStorage.getItem(_e);if(!t)return"";const n=JSON.parse(t);if(n&&typeof n=="object"){const o=n[e]??n[Number(e)]??null;return o?typeof o=="string"?o:(o==null?void 0:o.prompt)||"":""}return""}catch{return""}}function Se(e){if(!e)return"";const t=[],n=Me(e.id);return n&&t.push(n),e.description&&t.push(`è§’è‰²å®šä½ï¼š
${e.description}`),e.personality&&t.push(`æ€§æ ¼ç‰¹å¾ï¼š
${e.personality}`),e.background&&t.push(`èƒŒæ™¯ä¿¡æ¯ï¼š
${e.background}`),e.responseFormat&&t.push(`å›ç­”æ ¼å¼è¦æ±‚ï¼š
${e.responseFormat}`),t.join(`

`).trim()}function Te(e,t){const n=[],o=Se(t);return o&&n.push({role:"system",content:o}),n.push({role:"user",content:e}),n}function Ce(){return`
  <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
    <rect x="6" y="1" width="4" height="2" fill="#5d4037"/>
    <rect x="5" y="3" width="6" height="2" fill="#5d4037"/>
    <rect x="4" y="5" width="8" height="1" fill="#5d4037"/>
    <rect x="3" y="6" width="10" height="1" fill="#5d4037"/>
    <rect x="6" y="7" width="4" height="3" fill="#f3c26b"/>
    <rect x="5" y="10" width="6" height="4" fill="#6a1b9a"/>
    <rect x="11" y="9" width="1" height="5" fill="#2e7d32"/>
    <rect x="12" y="9" width="1" height="1" fill="#a5d6a7"/>
  </svg>`}function Le(){return`
  <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
    <rect x="6" y="6" width="4" height="3" fill="#f3c26b"/>
    <rect x="5" y="9" width="6" height="5" fill="#8e44ad"/>
    <rect x="9" y="4" width="3" height="2" fill="#7f8c8d"/>
    <rect x="3" y="10" width="3" height="2" fill="#c49b6e"/>
    <rect x="3" y="10" width="1" height="1" fill="#e74c3c"/>
    <rect x="4" y="11" width="1" height="1" fill="#3498db"/>
    <rect x="5" y="10" width="1" height="1" fill="#f1c40f"/>
  </svg>`}function xe(){return`
  <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
    <rect x="6" y="6" width="4" height="3" fill="#f3c26b"/>
    <rect x="5" y="9" width="6" height="5" fill="#34495e"/>
    <rect x="7" y="11" width="2" height="2" fill="#ecf0f1"/>
    <rect x="6" y="4" width="4" height="2" fill="#7f8c8d"/>
  </svg>`}function ce(){return`
  <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
    <rect x="6" y="6" width="4" height="3" fill="#f3c26b"/>
    <rect x="5" y="9" width="6" height="5" fill="#6d4c41"/>
  </svg>`}function T(e){return e==="æ™ºæ…§å¯¼å¸ˆ"?Ce():e==="åˆ›æ„åŠ©æ‰‹"?Le():e==="å•†ä¸šé¡¾é—®"?xe():ce()}function X(e){return new Date(e).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})}function Ae(e){const t=Date.now()-e,n=60*1e3,o=60*n,s=24*o;return t<n?"åˆšåˆš":t<o?`${Math.floor(t/n)}åˆ†é’Ÿå‰`:t<s?`${Math.floor(t/o)}å°æ—¶å‰`:new Date(e).toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})}function ke(e){if(!e)return;if(e.includes("åˆšåˆš"))return Date.now();const t=e.match(/(\d+)åˆ†é’Ÿ/);if(t)return Date.now()-parseInt(t[1],10)*60*1e3;const n=e.match(/(\d+)å°æ—¶/);if(n)return Date.now()-parseInt(n[1],10)*60*60*1e3}function N(){var o;const e=document.getElementById("historyList");if(!e)return;e.innerHTML="";const t=(((o=document.getElementById("historySearch"))==null?void 0:o.value)||"").trim().toLowerCase(),n=[];u.forEach(s=>{const r=p[s.id]||[];if(r.length){const a=r[r.length-1];n.push({type:"current",char:s,sessionId:"current",lastMsg:a,lastTs:a.timestamp})}(S[s.id]||[]).forEach(a=>{const c=a.messages[a.messages.length-1];n.push({type:"archived",char:s,sessionId:a.id,lastMsg:c,lastTs:(c==null?void 0:c.timestamp)||0})})}),n.sort((s,r)=>r.lastTs-s.lastTs),n.forEach(s=>{const{char:r,type:a,sessionId:c,lastMsg:d,lastTs:g}=s,m=g?Ae(g):"",h=d?d.text:a==="archived"?"å†å²ä¼šè¯":"æš‚æ— å¯¹è¯";if(t&&!(r.name.toLowerCase().includes(t)||h.toLowerCase().includes(t)))return;const v=document.createElement("div");v.className="history-item",v.onclick=()=>{a==="archived"?De(r.id,c):(_=null,Q(r.id))},v.innerHTML=`
      <div class="history-main">
        <div class="history-title">
          <span class="history-name">${h}</span>
          <span class="history-time">${m}</span>
        </div>
      </div>
      <button class="history-del-btn" title="åˆ é™¤" aria-label="åˆ é™¤">
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
          <path d="M10 11v6"></path>
          <path d="M14 11v6"></path>
          <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>
        </svg>
      </button>
    `;const y=v.querySelector(".history-del-btn");y.onclick=w=>{w.stopPropagation(),Ne(r.id,a,c)},e.appendChild(v)})}function De(e,t){const n=document.getElementById("chatMessages");if(!n)return;n.innerHTML="";const o=(S[e]||[]).find(s=>s.id===t);o&&(_={charId:e,sessionId:t},o.messages.forEach(s=>K(s)))}function Ne(e,t,n){if(window.confirm("ç¡®å®šåˆ é™¤è¯¥å¯¹è¯å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤")){if(t==="archived"){if(S[e]=(S[e]||[]).filter(s=>s.id!==n),_&&_.charId===e&&_.sessionId===n){_=null;const s=document.getElementById("chatMessages");s&&(s.innerHTML="")}}else if(p[e]=[],!_&&l&&l.id===e){const s=document.getElementById("chatMessages");s&&(s.innerHTML="")}N()}}function U(){const e=document.getElementById("roleDropdown");if(!e)return;e.innerHTML="";const t=l==null?void 0:l.id;u.forEach(n=>{const o=document.createElement("div");o.className=`model-item ${t&&n.id===t?"active":""}`,o.innerHTML=`
      <div class="avatar">${T(n.name)}</div>
      <div class="name">${n.name}</div>
    `,o.onclick=()=>{Q(n.id),le();const s=document.getElementById("roleSwitcherLabel");s&&(s.textContent=l.name);const r=document.getElementById("currentCharacterAvatar");r&&(r.classList.remove("pulse"),r.offsetWidth,r.classList.add("pulse"))},e.appendChild(o)})}function oe(){const e=document.getElementById("roleDropdown");e&&(e.classList.contains("hidden")?(U(),e.classList.remove("hidden"),e.classList.add("show")):(e.classList.remove("show"),e.classList.add("hidden")))}function le(){const e=document.getElementById("roleDropdown");e==null||e.classList.add("hidden")}function q(){const e=document.getElementById("characterList");e&&(e.innerHTML="",u.forEach(t=>{const n=document.createElement("div"),o=l&&t.id===l.id;n.className=`character-item ${o?"active":""}`,n.onclick=()=>Q(t.id),n.innerHTML=`
      <div class="character-header">
        <div class="character-avatar">${T(t.name)}</div>
        <div class="character-name">${t.name}</div>
      </div>
      <div class="character-desc">${t.description}</div>
      <div style="font-size: 10px; color: #8b4513; margin-top: 5px;">
        æœ€åå¯¹è¯ï¼š${t.lastActive}
      </div>
    `,e.appendChild(n)}))}function z(){const e=document.getElementById("characterManagement");e&&(e.innerHTML="",u.forEach(t=>{const n=document.createElement("div");n.className="character-card",n.innerHTML=`
      <div class="character-avatar" style="width: 60px; height: 60px; font-size: 30px;">${t.icon}</div>
      <div class="character-card-info">
        <h3>${t.name}</h3>
        <p>æè¿°ï¼š${t.description}</p>
        <p>æ€§æ ¼ï¼š${t.personality}</p>
        ${t.background?`<p>èƒŒæ™¯ï¼š${t.background}</p>`:""}
        ${t.responseFormat?`<p>å›ç­”æ ¼å¼ï¼š${t.responseFormat}</p>`:""}
        <div class="meta">åˆ›å»ºæ—¶é—´ï¼š${t.createdAt}</div>
      </div>
      <div class="character-actions">
        <button class="btn btn-small btn-edit" onclick="editCharacter(${t.id})">ç¼–è¾‘</button>
        <button class="btn btn-small btn-delete" onclick="deleteCharacter(${t.id})">åˆ é™¤</button>
      </div>
    `,e.appendChild(n)}))}function Q(e){const t=u.find(s=>s.id===e);if(!t)return;l=t,q(),U(),H(e);const n=document.getElementById("currentCharacterAvatar"),o=document.getElementById("currentCharacterName");n&&(n.innerHTML=T(l.name)),o&&(o.textContent=l.name)}function H(e){const t=document.getElementById("chatMessages");if(!t)return;t.innerHTML="",(p[e]||[]).forEach(o=>{K(o)}),t.scrollTop=t.scrollHeight}function K(e){const t=document.getElementById("chatMessages");if(!t)return;const n=document.createElement("div");n.className=`message ${e.type}`;const o=e.type==="ai"?T(l.name):ce(),s=t.lastElementChild;if(s&&s.classList.contains(e.type)&&n.classList.add("grouped"),e.type==="ai"){n.innerHTML=`
      <div class="message-avatar">${o}</div>
      <div class="message-content"><div class="message-text"></div></div>
      <div class="message-time outside">${e.time}</div>
    `;try{const a=n.querySelector(".message-text");a&&(a.innerHTML=Oe(e.text))}catch{n.querySelector(".message-text").textContent=e.text}}else{n.innerHTML=`
      <div class="message-time outside">${e.time}</div>
      <div class="message-content"><div class="message-text"></div></div>
      <div class="message-avatar">${o}</div>
    `;const a=n.querySelector(".message-text");a.textContent=e.text}t.appendChild(n)}function de(){if(!l||Z)return;const e=document.getElementById("messageInput");if(!e)return;const t=e.value.trim();if(!t)return;const n=Date.now(),o={type:"user",text:t,time:X(n),timestamp:n};_=null,p[l.id]=p[l.id]||[],p[l.id].push(o),K(o),e.value="",re(),se(!0);const s=document.getElementById("chatMessages"),r=document.createElement("div");r.className="message ai typing",r.innerHTML=`
    <div class="message-avatar">${T(l.name)}</div>
    <div class="message-content"><div class="typing-dots"><span></span><span></span><span></span></div></div>
  `,s.appendChild(r),setTimeout(()=>{const a=d=>{const g=Date.now(),m={type:"ai",author:l.name,text:d,time:X(g),timestamp:g};r.remove(),p[l.id].push(m),K(m);const h=document.getElementById("chatMessages");h&&(h.scrollTop=h.scrollHeight),re(),se(!1)},c=Te(t,l);localStorage.getItem("dev_enabled")==="true"?ue().then(()=>{i.dev=i.dev||{},i.dev.enabled=!0,i.dev.llmBase=localStorage.getItem("dev_llm_base")||i.dev.llmBase,localStorage.getItem("dev_api_key");let d="";Ve(c,g=>{d+=g;const m=r.querySelector(".message-content");m&&(m.innerHTML=d);const h=document.getElementById("chatMessages");h&&(h.scrollTop=h.scrollHeight)},()=>{a(d||"")},g=>{const m=typeof g=="string"?g:(g==null?void 0:g.message)||"æœªçŸ¥é”™è¯¯";a(`è°ƒç”¨å¤±è´¥ï¼š${m}`)})}):a(He(t,l))},1e3)}function He(e,t){const o={æ™ºæ…§å¯¼å¸ˆ:["è¿™æ˜¯ä¸€ä¸ªå¾ˆæœ‰è¶£çš„é—®é¢˜ï¼Œè®©æˆ‘æ¥ä¸ºä½ è¯¦ç»†è§£ç­”ã€‚","ä»æˆ‘çš„ç»éªŒæ¥çœ‹ï¼Œè¿™ä¸ªé—®é¢˜æœ‰å‡ ä¸ªå…³é”®ç‚¹éœ€è¦è€ƒè™‘ã€‚","ä½ æå‡ºäº†ä¸€ä¸ªå¾ˆå¥½çš„è§‚ç‚¹ï¼Œæˆ‘å»ºè®®ä½ å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ·±å…¥æ€è€ƒã€‚"],åˆ›æ„åŠ©æ‰‹:["å“‡ï¼è¿™ä¸ªæƒ³æ³•å¤ªæœ‰åˆ›æ„äº†ï¼æˆ‘æœ‰ä¸€äº›æ›´æœ‰è¶£çš„å»ºè®®ç»™ä½ ã€‚","è®©æˆ‘å‘æŒ¥ä¸€ä¸‹æƒ³è±¡åŠ›ï¼Œæˆ‘è§‰å¾—å¯ä»¥è¿™æ ·è®¾è®¡...","è¿™ä¸ªæ¦‚å¿µå¾ˆæ£’ï¼æˆ‘ä»¬å¯ä»¥åŠ å…¥æ›´å¤šåˆ›æ–°çš„å…ƒç´ ã€‚"],å•†ä¸šé¡¾é—®:["ä»å•†ä¸šè§’åº¦åˆ†æï¼Œè¿™ä¸ªæ–¹æ¡ˆæœ‰å‡ ä¸ªä¼˜åŠ¿å’Œéœ€è¦æ³¨æ„çš„é£é™©ã€‚","æ ¹æ®å¸‚åœºè°ƒç ”æ•°æ®ï¼Œæˆ‘å»ºè®®é‡‡ç”¨ä»¥ä¸‹ç­–ç•¥æ¥ä¼˜åŒ–è¿™ä¸ªé¡¹ç›®ã€‚","è¿™ä¸ªæŠ•èµ„æœºä¼šçœ‹èµ·æ¥å¾ˆæœ‰æ½œåŠ›ï¼Œä½†æˆ‘ä»¬éœ€è¦ä»”ç»†è¯„ä¼°ROIã€‚"]}[t.name]||["è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼Œè®©æˆ‘ä¸ºä½ åˆ†æä¸€ä¸‹ã€‚"];return o[Math.floor(Math.random()*o.length)]}function Oe(e){if(!e)return"";let t=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");const n=[];return t=t.replace(/```([a-zA-Z0-9_-]+)?\n([\s\S]*?)```/g,(o,s,r)=>{const a=`__CODE_${n.length}__`;return n.push(`<pre><code class="lang-${s||"plain"}">${r}</code></pre>`),a}),t=t.replace(/^######\s+(.+)$/gm,"<h6>$1</h6>").replace(/^#####\s+(.+)$/gm,"<h5>$1</h5>").replace(/^####\s+(.+)$/gm,"<h4>$1</h4>").replace(/^###\s+(.+)$/gm,"<h3>$1</h3>").replace(/^##\s+(.+)$/gm,"<h2>$1</h2>").replace(/^#\s+(.+)$/gm,"<h1>$1</h1>"),t=t.replace(/^>\s+(.+)$/gm,"<blockquote>$1</blockquote>"),t=t.replace(/^(?:\-|\*)\s+(.+)$/gm,"<li>$1</li>"),t=t.replace(/(?:<li>.*<\/li>\n?)+/gs,o=>`<ul>${o}</ul>`),t=t.replace(/^(\d+)\.\s+(.+)$/gm,"<li>$2</li>"),t=t.replace(/(?:<li>.*<\/li>\n?)+/gs,o=>o.startsWith("<ul>")?o:`<ol>${o}</ol>`),t=t.replace(/\[([^\]]+)\]\((https?:[^)\s]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'),t=t.replace(/`([^`]+)`/g,"<code>$1</code>"),t=t.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),t=t.replace(new RegExp("(?<!\\*)\\*(?!\\*)(.+?)(?<!\\*)\\*(?!\\*)","g"),"<em>$1</em>"),t=t.replace(/^(-{3,}|\*{3,})$/gm,"<hr/>"),t=t.replace(/(^|\n)(?!<(h\d|ul|ol|li|pre|blockquote|hr|p|code))([^\n]+)(?=\n|$)/g,(o,s,r,a)=>`${s}<p>${a}</p>`),n.forEach((o,s)=>{t=t.replace(`__CODE_${s}__`,o)}),t}async function Ve(e,t,n,o){var h,v,y,w,E,C,I,b,B,$,O;const s=new AbortController,r=2e4,a=12e4;let c=null,d=null;const g=()=>{c&&clearTimeout(c),c=setTimeout(()=>{s.abort("idle-timeout")},r)},m=()=>{c&&clearTimeout(c),d&&clearTimeout(d),c=null,d=null};try{const M=localStorage.getItem("dev_llm_base")||((h=i==null?void 0:i.dev)==null?void 0:h.llmBase),L=localStorage.getItem("dev_api_key")||"",x=localStorage.getItem("cfg_llm_model")||((y=(v=i.defaults)==null?void 0:v.llm)==null?void 0:y[0])||"",k=Array.isArray(e)&&e.length?e:[{role:"user",content:typeof e=="string"?e:""}];if(!M||!L||!x)throw new Error("ç¼ºå°‘ base/key/model");const V=((w=i==null?void 0:i.dev)==null?void 0:w.authHeader)||"Authorization",P=((E=i==null?void 0:i.dev)==null?void 0:E.authScheme)||"Bearer";d=setTimeout(()=>s.abort("hard-timeout"),a),g();const f=await fetch(`${M}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"text/event-stream",[V]:`${P} ${L}`},body:JSON.stringify({model:x,stream:!0,messages:k}),signal:s.signal});if(!f.ok){const Y=await f.text();throw new Error(Y||`HTTP ${f.status}`)}const R=f.body.getReader(),fe=new TextDecoder;let W="";for(;;){const{value:Y,done:ve}=await R.read();if(ve)break;g(),W+=fe.decode(Y,{stream:!0});const j=W.split(/\r?\n\r?\n/);W=j.pop();for(const pe of j){const ye=pe.split(/\r?\n/).filter(Boolean);for(const we of ye){const ee=we.replace(/\r$/,"").match(/^data:\s*(.*)$/);if(!ee)continue;const te=(ee[1]||"").trim();if(te==="[DONE]"){m(),n&&n();return}try{const A=JSON.parse(te),ne=((b=(I=(C=A==null?void 0:A.choices)==null?void 0:C[0])==null?void 0:I.delta)==null?void 0:b.content)||((O=($=(B=A==null?void 0:A.choices)==null?void 0:B[0])==null?void 0:$.message)==null?void 0:O.content)||"";ne&&t&&t(ne)}catch{}}}}m(),n&&n()}catch(M){m(),o&&o(M)}}function Pe(e){e.key==="Enter"&&(e.preventDefault(),Z||de())}function Re(){const e=document.getElementById("chatInterface"),t=document.getElementById("settingsInterface");e==null||e.classList.remove("active"),t==null||t.classList.add("active")}function Fe(){const e=document.getElementById("chatInterface"),t=document.getElementById("settingsInterface");t==null||t.classList.remove("active"),e==null||e.classList.add("active")}function me(e,t){var o;document.querySelectorAll(".menu-item").forEach(s=>s.classList.remove("active")),e.currentTarget.classList.add("active");const n={characters:document.getElementById("panel-characters"),models:document.getElementById("panel-models")};Object.values(n).forEach(s=>s==null?void 0:s.classList.add("hidden")),(o=n[t])==null||o.classList.remove("hidden")}let i=null;function ue(){return i?Promise.resolve(i):fetch("/app-config.json",{cache:"no-store"}).then(e=>e.json()).then(e=>i=e).catch(()=>i={defaults:{}})}function F(e,t){var s,r,a,c;const o={VITE_LLM_MODELS:(s=i==null?void 0:i.defaults)==null?void 0:s.llm,VITE_ASR_MODELS:(r=i==null?void 0:i.defaults)==null?void 0:r.asr,VITE_TTS_VOICES:(a=i==null?void 0:i.defaults)==null?void 0:a.ttsVoices,VITE_VOICE_MODELS:(c=i==null?void 0:i.defaults)==null?void 0:c.voiceModels}[e];return Array.isArray(o)&&o.length?o:t}function qe(){const e=F("VITE_LLM_MODELS",["gpt-4o-mini","claude-3.5-haiku","qwen2.5-14b"]),t=F("VITE_ASR_MODELS",["deepgram:nova-2","whisper:large-v3","azure:speech"]),n=F("VITE_TTS_VOICES",["openai:alloy","elevenlabs:Rachel","azure:zh-CN-XiaoxiaoNeural"]),o=F("VITE_VOICE_MODELS",["openai:gpt-4o-realtime","deepgram:aura"]),s=(g,m)=>{try{const h=localStorage.getItem(g);return h?JSON.parse(h):m}catch{return m}},r=s("visible_llm_models",e).filter(Boolean),a=s("visible_asr_models",t).filter(Boolean),c=s("visible_tts_voices",n).filter(Boolean),d=s("visible_voice_models",o).filter(Boolean);return{llm:r,asr:a,ttsVoices:c,voiceModels:d}}function ge(){var o,s,r,a;const e=document.getElementById("panel-models");if(!e)return;const t=c=>{var E,C;const{llm:d,asr:g,ttsVoices:m,voiceModels:h}=c,v=(I,b)=>localStorage.getItem(I)||b,y={llm:v("cfg_llm_model",d[0]||""),asr:v("cfg_asr_model",g[0]||""),tts:v("cfg_tts_voice",m[0]||""),vrm:v("cfg_voice_model",h[0]||"")},w=(I,b)=>I.map(B=>`<option value="${B}" ${B===b?"selected":""}>${B}</option>`).join("");e.innerHTML=`
      <div class="form-section">
        <div class="form-row">
          <label>æ–‡æœ¬ LLM</label>
          <select id="sel-llm" class="select">${w(d,y.llm)}</select>
        </div>
        <div class="form-row">
          <label>ASRï¼ˆè¯­éŸ³è¯†åˆ«ï¼‰</label>
          <select id="sel-asr" class="select">${w(g,y.asr)}</select>
        </div>
        <div class="form-row">
          <label>TTS å£°éŸ³</label>
          <select id="sel-tts" class="select">${w(m,y.tts)}</select>
        </div>
        <div class="form-row">
          <label>è¯­éŸ³å¤§æ¨¡å‹</label>
          <select id="sel-vrm" class="select">${w(h,y.vrm)}</select>
        </div>
        <div class="form-actions">
          <button id="btn-save-models" class="btn">ä¿å­˜</button>
          <button id="btn-reset-models" class="btn btn-secondary">æ¢å¤é»˜è®¤</button>
        </div>
      </div>
    `,(E=document.getElementById("btn-save-models"))==null||E.addEventListener("click",()=>{const I=document.getElementById("sel-llm"),b=document.getElementById("sel-asr"),B=document.getElementById("sel-tts"),$=document.getElementById("sel-vrm");localStorage.setItem("cfg_llm_model",(I==null?void 0:I.value)||""),localStorage.setItem("cfg_asr_model",(b==null?void 0:b.value)||""),localStorage.setItem("cfg_tts_voice",(B==null?void 0:B.value)||""),localStorage.setItem("cfg_voice_model",($==null?void 0:$.value)||""),alert("å·²ä¿å­˜æ¨¡å‹ä¸å£°éŸ³é€‰æ‹©")}),(C=document.getElementById("btn-reset-models"))==null||C.addEventListener("click",()=>{localStorage.removeItem("cfg_llm_model"),localStorage.removeItem("cfg_asr_model"),localStorage.removeItem("cfg_tts_voice"),localStorage.removeItem("cfg_voice_model"),ge()})};t(qe());const n=(i==null?void 0:i.visibleModelsUrl)||"";if(n&&fetch(n).then(c=>c.json()).then(c=>{const d={llm:c.llm||c.llms||[],asr:c.asr||c.asrs||[],ttsVoices:c.ttsVoices||c.tts||[],voiceModels:c.voiceModels||c.vrm||[]};(d.llm.length||d.asr.length||d.ttsVoices.length||d.voiceModels.length)&&t(d)}).catch(()=>{}),localStorage.getItem("dev_enabled")==="true"){const c=localStorage.getItem("dev_llm_base")||((o=i==null?void 0:i.dev)==null?void 0:o.llmBase),d=localStorage.getItem("dev_api_key"),g=((s=i==null?void 0:i.dev)==null?void 0:s.modelsEndpoint)||"/models";c&&d&&fetch(`${c}${g}`,{headers:{[((r=i==null?void 0:i.dev)==null?void 0:r.authHeader)||"Authorization"]:`${((a=i==null?void 0:i.dev)==null?void 0:a.authScheme)||"Bearer"} ${d}`}}).then(m=>m.json()).then(m=>{var v,y,w;const h=Array.isArray(m==null?void 0:m.data)?m.data.map(E=>E.id).filter(Boolean):(m==null?void 0:m.models)||[];if(h.length){const E={llm:h,asr:[],ttsVoices:[],voiceModels:[]},C=localStorage.getItem("dev_asr_base")||c,I=localStorage.getItem("dev_asr_key")||d,b=localStorage.getItem("dev_tts_base")||c,B=localStorage.getItem("dev_tts_key")||d,$=localStorage.getItem("dev_vrm_base")||c,O=localStorage.getItem("dev_vrm_key")||d,M=(L,x,k)=>{var V,P;return!k||!L||!x?Promise.resolve([]):fetch(`${L}${k}`,{headers:{[((V=i==null?void 0:i.dev)==null?void 0:V.authHeader)||"Authorization"]:`${((P=i==null?void 0:i.dev)==null?void 0:P.authScheme)||"Bearer"} ${x}`}}).then(f=>f.json()).then(f=>Array.isArray(f==null?void 0:f.data)?f.data.map(R=>R.id||R.name).filter(Boolean):(f==null?void 0:f.items)||(f==null?void 0:f.models)||[]).catch(()=>[])};Promise.all([M(C,I,(v=i==null?void 0:i.dev)==null?void 0:v.asrModelsEndpoint),M(b,B,(y=i==null?void 0:i.dev)==null?void 0:y.ttsVoicesEndpoint),M($,O,(w=i==null?void 0:i.dev)==null?void 0:w.voiceModelsEndpoint)]).then(([L,x,k])=>{E.asr=L,E.ttsVoices=x,E.voiceModels=k,t(E)})}}).catch(()=>{})}}function ze(){D=null;const e=document.getElementById("modalTitle");e.textContent="æ·»åŠ æ–°äººç‰©",document.getElementById("characterForm").reset(),document.getElementById("characterModal").style.display="block"}function Ke(e){const t=u.find(n=>n.id===e);t&&(D=e,document.getElementById("modalTitle").textContent="ç¼–è¾‘äººç‰©",document.getElementById("characterName").value=t.name,document.getElementById("characterIcon").value=t.icon,document.getElementById("characterDesc").value=t.description,document.getElementById("characterPersonality").value=t.personality,document.getElementById("characterBackground").value=t.background||"",document.getElementById("characterFormat").value=t.responseFormat||"",document.getElementById("characterModal").style.display="block")}function Ge(e){if(confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäººç‰©å—ï¼Ÿ"))if(u=u.filter(t=>t.id!==e),delete p[e],l&&l.id===e&&u.length>0?l=u[0]:u.length||(l=null),J(u),q(),z(),G(),u.length>0&&l){H(l.id);const t=document.getElementById("currentCharacterAvatar");t&&(t.innerHTML=T(l.name));const n=document.getElementById("currentCharacterName");n&&(n.textContent=l.name)}else{const t=document.getElementById("currentCharacterAvatar");t&&(t.textContent="");const n=document.getElementById("currentCharacterName");n&&(n.textContent="");const o=document.getElementById("chatMessages");o&&(o.innerHTML="")}}function he(){document.getElementById("characterModal").style.display="none"}function G(){const e=u.length,t=Object.values(p).reduce((a,c)=>a+c.filter(d=>d.type==="user").length,0),n=u.reduce((a,c)=>a.conversationCount>c.conversationCount?a:c,u[0]),o=document.getElementById("totalCharacters"),s=document.getElementById("totalConversations"),r=document.getElementById("mostActive");o&&(o.textContent=e),s&&(s.textContent=t),r&&(r.textContent=n?n.name:"æ— ")}function re(){if(!l)return;const e=u.find(t=>t.id===l.id);e&&(e.lastActive="åˆšåˆš",e.conversationCount=(e.conversationCount||0)+1,J(u)),N(),z(),U(),G()}function Je(){alert("é™„ä»¶åŠŸèƒ½å¼€å‘ä¸­...")}function Ue(){alert("è¯­éŸ³é€šè¯åŠŸèƒ½å¼€å‘ä¸­...")}document.addEventListener("DOMContentLoaded",()=>{ue().then(()=>{if($e(),q(),N(),U(),z(),l){H(l.id);const s=document.getElementById("currentCharacterAvatar");s&&(s.innerHTML=T(l.name));const r=document.getElementById("currentCharacterName");r&&(r.textContent=l.name)}G(),me({currentTarget:document.querySelector(".settings-menu .menu-item")},"characters"),ge();const e=document.getElementById("historySearch");e==null||e.addEventListener("input",()=>{N()}),document.body.setAttribute("data-theme","light"),localStorage.setItem("theme","light");const t=document.getElementById("currentCharacterAvatar");t==null||t.addEventListener("click",s=>{s.stopPropagation();const r=document.getElementById("roleDropdown");if(r){const a=t.getBoundingClientRect(),c=document.querySelector(".chat-header").getBoundingClientRect();r.style.left=`${a.left-c.left}px`,r.style.top=`${a.bottom-c.top+8}px`}oe()});const n=document.getElementById("roleNameButton");n==null||n.addEventListener("click",s=>{s.stopPropagation();const r=document.getElementById("roleDropdown");if(r){const a=n.getBoundingClientRect(),c=document.querySelector(".chat-header").getBoundingClientRect();r.style.left=`${a.left-c.left}px`,r.style.top=`${a.bottom-c.top+8}px`}oe()}),document.addEventListener("click",s=>{const r=document.getElementById("roleDropdown");if(!r||r.classList.contains("hidden"))return;const a=document.getElementById("currentCharacterAvatar"),c=document.getElementById("roleNameButton");r.contains(s.target)||a!=null&&a.contains(s.target)||c!=null&&c.contains(s.target)||le()});const o=document.getElementById("characterForm");o==null||o.addEventListener("submit",s=>{s.preventDefault();const r={name:document.getElementById("characterName").value,icon:document.getElementById("characterIcon").value,description:document.getElementById("characterDesc").value,personality:document.getElementById("characterPersonality").value,background:document.getElementById("characterBackground").value,responseFormat:document.getElementById("characterFormat").value};if(D){const a=u.find(c=>c.id===D);a&&Object.assign(a,r)}else{const a={id:Date.now(),...r,createdAt:new Date().toISOString().split("T")[0],lastActive:"åˆšåˆš",conversationCount:0};u.push(a),p[a.id]=[],l=a,D=null}if(J(u),q(),N(),z(),l){H(l.id);const a=document.getElementById("currentCharacterAvatar");a&&(a.innerHTML=T(l.name));const c=document.getElementById("currentCharacterName");c&&(c.textContent=l.name)}G(),he(),D=null})})});window.showSettings=Re;window.showChat=Fe;window.showSettingsTab=me;window.showAddCharacterModal=ze;window.editCharacter=Ke;window.deleteCharacter=Ge;window.closeCharacterModal=he;window.sendMessage=de;window.handleKeyPress=Pe;window.attachFile=Je;window.startVoiceCall=Ue;window.setTheme=e=>{document.body.setAttribute("data-theme",e),localStorage.setItem("theme",e)};window.newConversation=()=>{if(!l)return;const e=l.id;_&&_.charId===e&&(_=null);const t=p[e]||[];S[e]=S[e]||[],t&&t.length>0&&S[e].push({id:`${e}-${Date.now()}`,messages:t}),p[e]=[],_=null,H(e),N()};
